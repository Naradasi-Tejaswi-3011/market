<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lead Scorer - MarketAI Suite</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>
    <nav class="navbar">
        <div class="nav-brand">
            <h1><span class="logo-icon"></span> MarketAI Suite</h1>
        </div>
        <div class="nav-menu">
            <a href="/" class="nav-link">Home</a>
            <a href="/campaign" class="nav-link">Campaigns</a>
            <a href="/pitch" class="nav-link">Pitches</a>
            <a href="/lead" class="nav-link active">Leads</a>
            <a href="/social-media" class="nav-link">Post Creation</a>
            <button id="logoutBtn" class="btn btn-logout">Logout</button>
        </div>
    </nav>

    <main class="container">
        <div class="page-header">
            <h2>‚≠ê Lead Scoring System</h2>
            <p>Intelligent lead qualification with detailed reasoning</p>
        </div>

        <div class="content-grid">
            <!-- Input Form -->
            <div class="form-section">
                <h3>Lead Profile</h3>
                <form id="leadForm" class="form-group">
                    <div>
                        <label for="budget">Budget *</label>
                        <select id="budget" name="budget" required>
                            <option value="">Select budget...</option>
                            <option value="Under ‚Çπ10L">Under ‚Çπ10L</option>
                            <option value="‚Çπ10L ‚Äì ‚Çπ50L">‚Çπ10L ‚Äì ‚Çπ50L</option>
                            <option value="‚Çπ50L ‚Äì ‚Çπ2Cr">‚Çπ50L ‚Äì ‚Çπ2Cr</option>
                            <option value="‚Çπ2Cr ‚Äì ‚Çπ5Cr">‚Çπ2Cr ‚Äì ‚Çπ5Cr</option>
                            <option value="Over ‚Çπ5Cr">Over ‚Çπ5Cr</option>
                        </select>
                    </div>

                    <div>
                        <label for="business_need">Business Need *</label>
                        <input type="text" id="business_need" name="business_need"
                            placeholder="e.g., Inventory management, marketing automation" required>
                    </div>

                    <div>
                        <label for="urgency">Urgency *</label>
                        <select id="urgency" name="urgency" required>
                            <option value="">Select urgency...</option>
                            <option value="High - Need immediately">High - Need immediately</option>
                            <option value="Medium - Within 3 months">Medium - Within 3 months</option>
                            <option value="Low - 6+ months">Low - 6+ months</option>
                            <option value="Exploring options">Exploring options</option>
                        </select>
                    </div>

                    <div>
                        <label for="authority">Authority Level *</label>
                        <select id="authority" name="authority" required>
                            <option value="">Select authority...</option>
                            <option value="Primary Decision Maker">Primary Decision Maker</option>
                            <option value="Budget Approver">Budget Approver</option>
                            <option value="Technical Influencer">Technical Influencer</option>
                            <option value="End User">End User</option>
                        </select>
                    </div>

                    <div>
                        <label for="industry">Industry *</label>
                        <select id="industry" name="industry" required>
                            <option value="">Select industry...</option>
                            <option value="SaaS">SaaS</option>
                            <option value="Healthcare">Healthcare</option>
                            <option value="EdTech">EdTech</option>
                            <option value="Retail">Retail</option>
                            <option value="FinTech">FinTech</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>

                    <button type="submit" class="btn btn-primary btn-block">
                        Score Lead
                    </button>
                </form>

                <div id="formMessage" class="message"></div>
            </div>

            <!-- Output Results -->
            <div class="results-section">
                <div id="loadingSpinner" class="spinner" style="display: none;">
                    <div class="spinner-content">
                        <div class="spinner-circle"></div>
                        <p>Analyzing lead profile...</p>
                    </div>
                </div>

                <!-- Initial Placeholder Card -->
                <div id="placeholderCard" class="placeholder-card">
                    <div class="placeholder-icon">ü§ñ</div>
                    <h3>Lead Qualification Insights</h3>
                    <p>AI evaluates leads based on <strong>Budget, Need, Urgency, Authority,</strong> and
                        <strong>Industry fit.</strong>
                    </p>
                    <p class="secondary-text">Enter lead details and click "Score Lead" to see a detailed assessment.
                    </p>
                </div>

                <div id="leadOutput" style="display: none;">
                    <div class="insights-header" style="position: relative; margin-bottom: 1.5rem;">
                        <h3 style="margin-right: 50px;">üìä Lead Qualification Insights</h3>
                        <button type="button" class="modal-close" onclick="window.closeLeadOutput()" title="Close"
                            style="position: absolute; right: 0; top: 50%; transform: translateY(-50%);">&times;</button>
                    </div>

                    <!-- Tab Navigation -->
                    <div class="tabs-container">
                        <div class="tabs-nav">
                            <button class="tab-btn active" onclick="switchTab('overview')">Overview</button>
                            <button class="tab-btn" onclick="switchTab('breakdown')">Breakdown</button>
                            <button class="tab-btn" onclick="switchTab('analysis')">Detailed Analysis</button>
                            <button class="tab-btn" onclick="switchTab('strategy')">Strategy</button>
                        </div>
                    </div>

                    <!-- Tab Contents -->
                    <div class="tab-content" id="overview-tab">
                        <div class="output-card lead-score-card">
                            <div class="score-display-large">
                                <div class="score-circle-large" id="scoreCircle">0</div>
                                <div class="score-label">
                                    <p id="scoreTierText" class="category-tier"></p>
                                    <p id="scoreIntentText" class="intent-text"></p>
                                    <p id="conversionProb" class="conversion"></p>
                                </div>
                            </div>
                        </div>
                        <div class="output-card risk-card">
                            <div class="risk-level-container">
                                <p><strong>Risk Level:</strong> <span id="riskLevel" class="risk-badge"></span></p>
                            </div>
                            <div id="riskFactors" class="risk-list"></div>
                        </div>
                    </div>

                    <div class="tab-content" id="breakdown-tab" style="display: none;">
                        <div class="output-card">
                            <h4>üìà Score Breakdown</h4>
                            <div id="scoreBreakdown" class="score-breakdown"></div>
                        </div>
                    </div>

                    <div class="tab-content" id="analysis-tab" style="display: none;">
                        <div class="output-card">
                            <h4>üî¨ Detailed Analysis</h4>
                            <div id="detailedReasoning" class="reasoning-section"></div>
                        </div>
                    </div>

                    <div class="tab-content" id="strategy-tab" style="display: none;">
                        <div class="output-card sales-strategy">
                            <h4>üéØ Recommended Sales Strategy</h4>
                            <div id="salesStrategy" class="strategy-content"></div>
                        </div>
                        <div class="output-card recommended-actions">
                            <h4>üìå Recommended Next Actions:</h4>
                            <div id="nextActions"></div>
                        </div>
                    </div>

                </div>
            </div>

            <!-- Feedback Section -->
            <div id="feedbackSection" class="feedback-section" style="display: none;">
                <h4>Was this lead analysis helpful?</h4>
                <div class="feedback-buttons">
                    <button class="feedback-btn" id="feedbackUp" onclick="handleFeedback(true)">
                        üëç <span>Yes</span>
                    </button>
                    <button class="feedback-btn" id="feedbackDown" onclick="handleFeedback(false)">
                        üëé <span>No</span>
                    </button>
                </div>
                <div id="feedbackMsg" class="feedback-message">Thank you for your feedback!</div>
            </div>


        </div>
        </div>
        </div>
    </main>

    <footer class="footer">
        <p>&copy; 2026 MarketAI Suite - Explainable AI for Business Intelligence</p>
    </footer>

    <!-- Feedback Modal -->
    <div id="feedbackModalOverlay" class="modal-overlay">
        <div class="feedback-modal">
            <div class="modal-header">
                <h3>Share feedback</h3>
                <button class="close-modal" onclick="closeFeedbackModal()">&times;</button>
            </div>
            <div class="reason-chips" id="reasonChips">
                <button class="reason-chip" onclick="toggleReason(this)">Incorrect or incomplete</button>
                <button class="reason-chip" onclick="toggleReason(this)">Not what I asked for</button>
                <button class="reason-chip" onclick="toggleReason(this)">Slow or buggy</button>
                <button class="reason-chip" onclick="toggleReason(this)">Style or tone</button>
                <button class="reason-chip" onclick="toggleReason(this)">Safety or legal concern</button>
                <button class="reason-chip" onclick="toggleReason(this)">Other</button>
            </div>
            <textarea id="feedbackDetails" class="feedback-details" placeholder="Share details (optional)"></textarea>
            <div class="modal-disclaimer">
                Your conversation will be included with your feedback to help improve MarketAI. <a href="#">Learn
                    more</a>
            </div>
            <div class="modal-footer">
                <button id="submitDetailedFeedback" class="btn-submit-feedback" onclick="submitDetailedFeedback()"
                    disabled>Submit</button>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='app.js') }}"></script>
    <script>
        let currentLeadId = null;
        document.addEventListener('DOMContentLoaded', checkAuth);
        document.getElementById('leadForm').addEventListener('submit', scoreLead);
        document.getElementById('logoutBtn').addEventListener('click', logout);
        function switchTab(tabId) {
            // Update buttons
            const buttons = document.querySelectorAll('.tab-btn');
            buttons.forEach(btn => {
                if (btn.innerText.toLowerCase().includes(tabId.toLowerCase()) ||
                    (tabId === 'analysis' && btn.innerText.includes('Analysis'))) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });

            // Update content
            const contents = document.querySelectorAll('.tab-content');
            contents.forEach(content => {
                content.style.display = content.id === `${tabId}-tab` ? 'block' : 'none';
            });
        }

        async function scoreLead(e) {
            e.preventDefault();

            const token = localStorage.getItem('token');
            const formData = {
                budget: document.getElementById('budget').value,
                business_need: document.getElementById('business_need').value,
                urgency: document.getElementById('urgency').value,
                authority: document.getElementById('authority').value,
                industry: document.getElementById('industry').value
            };

            document.getElementById('loadingSpinner').style.display = 'flex';
            document.getElementById('leadOutput').style.display = 'none';
            document.getElementById('placeholderCard').style.display = 'none';
            const formMessage = document.getElementById('formMessage');
            formMessage.textContent = '';
            formMessage.classList.remove('error');
            formMessage.style.display = 'none';

            try {
                const response = await fetch('/api/leads/score', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();
                document.getElementById('loadingSpinner').style.display = 'none';

                if (response.ok) {
                    displayLeadOutput(data.lead_score);
                    currentLeadId = data.lead_id;
                    switchTab('overview');
                } else {
                    document.getElementById('formMessage').textContent = data.error || 'Error scoring lead';
                    document.getElementById('formMessage').classList.add('error');
                    document.getElementById('placeholderCard').style.display = 'block';
                }
            } catch (error) {
                document.getElementById('loadingSpinner').style.display = 'none';
                document.getElementById('formMessage').textContent = 'Network error. Please try again.';
                document.getElementById('formMessage').classList.add('error');
                document.getElementById('placeholderCard').style.display = 'block';
            }
        }

        function displayLeadOutput(leadScore) {
            const score = leadScore.lead_score;
            const category = leadScore.lead_category;
            const convProb = leadScore.conversion_probability;

            // Score circle with color coding
            document.getElementById('scoreCircle').textContent = score;
            const color = category === 'Hot' ? '#10b981' : category === 'Warm' ? '#f59e0b' : '#ef4444';
            document.getElementById('scoreCircle').style.borderColor = color;

            // Enhanced tier display
            const tierMap = {
                'Hot': { tier: 'A', intent: 'High buying intent. Immediate prioritization recommended.' },
                'Warm': { tier: 'B', intent: 'Moderate interest with positive indicators. Follow up within 48 hours.' },
                'Cold': { tier: 'C', intent: 'Limited immediate interest. Nurture for future opportunity.' }
            };

            const tierInfo = tierMap[category] || tierMap['Warm'];
            document.getElementById('scoreTierText').innerHTML = `üî• ${category} Lead (Tier ${tierInfo.tier})`;
            document.getElementById('scoreIntentText').textContent = tierInfo.intent;
            document.getElementById('conversionProb').textContent = `${convProb}% estimated conversion probability`;

            // Populate Lead Snapshot
            const formData = {
                industry: document.getElementById('industry').value,
                budget: document.getElementById('budget').value,
                urgency: document.getElementById('urgency').value,
                authority: document.getElementById('authority').value,
                business_need: document.getElementById('business_need').value
            };

            // Detailed reasoning
            const reasoning = leadScore.detailed_reasoning;
            document.getElementById('detailedReasoning').innerHTML = `
                <div class="reasoning-item">
                    <strong>Budget Analysis</strong>
                    <p>${reasoning.budget_analysis}</p>
                </div>
                <div class="reasoning-item">
                    <strong>Need Alignment</strong>
                    <p>${reasoning.need_alignment}</p>
                </div>
                <div class="reasoning-item">
                    <strong>Urgency Signal</strong>
                    <p>${reasoning.urgency_signal}</p>
                </div>
                <div class="reasoning-item">
                    <strong>Authority Assessment</strong>
                    <p>${reasoning.authority_assessment}</p>
                </div>
                <div class="reasoning-item">
                    <strong>Industry Context</strong>
                    <p>${reasoning.industry_context}</p>
                </div>
            `;

            // Score breakdown
            const breakdown = leadScore.score_breakdown;
            document.getElementById('scoreBreakdown').innerHTML = `
                <div class="breakdown-row">
                    <div class="breakdown-item-grid">
                        <label>Budget Fit: ${breakdown.budget_fit.score}/100</label>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${breakdown.budget_fit.score}%"></div>
                        </div>
                        <small>${breakdown.budget_fit.reasoning}</small>
                    </div>
                </div>
                <div class="breakdown-row">
                    <div class="breakdown-item-grid">
                        <label>Need Clarity: ${breakdown.need_clarity.score}/100</label>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${breakdown.need_clarity.score}%"></div>
                        </div>
                        <small>${breakdown.need_clarity.reasoning}</small>
                    </div>
                </div>
                <div class="breakdown-row">
                    <div class="breakdown-item-grid">
                        <label>Urgency Level: ${breakdown.urgency_level.score}/100</label>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${breakdown.urgency_level.score}%"></div>
                        </div>
                        <small>${breakdown.urgency_level.reasoning}</small>
                    </div>
                </div>
                <div class="breakdown-row">
                    <div class="breakdown-item-grid">
                        <label>Authority Level: ${breakdown.authority_level.score}/100</label>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${breakdown.authority_level.score}%"></div>
                        </div>
                        <small>${breakdown.authority_level.reasoning}</small>
                    </div>
                </div>
                <div class="breakdown-row">
                    <div class="breakdown-item-grid">
                        <label>Industry Fit: ${breakdown.industry_fit.score}/100</label>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${breakdown.industry_fit.score}%"></div>
                        </div>
                        <small>${breakdown.industry_fit.reasoning}</small>
                    </div>
                </div>
            `;

            // Risk Assessment with color-coded level
            const riskFactors = leadScore.risk_factors || [];
            let riskLevel = leadScore.risk_level || 'Low';
            let riskColor = '#10b981';

            if (riskLevel === 'High' || riskFactors.length > 2) {
                riskLevel = 'High';
                riskColor = '#ef4444';
            } else if (riskLevel === 'Medium' || riskFactors.length > 0) {
                riskLevel = 'Medium';
                riskColor = '#f59e0b';
            }

            const riskBadge = document.getElementById('riskLevel');
            riskBadge.textContent = riskLevel;
            riskBadge.style.backgroundColor = riskColor;
            riskBadge.style.color = '#fff';
            riskBadge.style.padding = '4px 12px';
            riskBadge.style.borderRadius = '4px';
            riskBadge.style.fontWeight = 'bold';

            document.getElementById('riskFactors').innerHTML = riskFactors.length > 0
                ? `<div class="risk-concerns"><strong>Primary Concerns:</strong><ul>${riskFactors.map(r => `<li>${r}</li>`).join('')}</ul></div>`
                : '<p class="low-risk">‚úì No significant risk factors identified</p>';

            // Sales Strategy Section
            const salesApproach = determineSalesApproach(category, formData.authority, formData.budget);
            document.getElementById('salesStrategy').innerHTML = `
                <div class="strategy-item">
                    <strong>Recommended Approach:</strong>
                    <p>${salesApproach.approach}</p>
                </div>
                <div class="strategy-item">
                    <strong>Key Messaging Angle:</strong>
                    <p>${salesApproach.messaging}</p>
                </div>
                <div class="strategy-item">
                    <strong>Engagement Recommendation:</strong>
                    <p>${salesApproach.engagement}</p>
                </div>
            `;

            // Next actions
            document.getElementById('nextActions').innerHTML = leadScore.next_actions
                .map(a => `<div class="action-item">‚Üí ${a}</div>`)
                .join('');

            document.getElementById('leadOutput').style.display = 'block';

            // Show feedback section and reset buttons
            document.getElementById('feedbackSection').style.display = 'block';
            document.getElementById('feedbackMsg').style.display = 'none';
            document.getElementById('feedbackUp').classList.remove('active-up');
            document.getElementById('feedbackDown').classList.remove('active-down');
            document.getElementById('feedbackUp').disabled = false;
            document.getElementById('feedbackDown').disabled = false;
        }

        async function handleFeedback(isPositive) {
            if (!currentLeadId) return;

            if (isPositive) {
                await submitFeedback(true);
                document.getElementById('feedbackMsg').style.display = 'block';
                document.getElementById('feedbackUp').classList.add('active-up');
                document.getElementById('feedbackDown').classList.remove('active-down');
                document.getElementById('feedbackUp').disabled = true;
                document.getElementById('feedbackDown').disabled = true;
            } else {
                openFeedbackModal();
            }
        }

        function openFeedbackModal() {
            document.getElementById('feedbackModalOverlay').classList.add('active');
            const chips = document.querySelectorAll('.reason-chip');
            chips.forEach(c => c.classList.remove('selected'));
            document.getElementById('feedbackDetails').value = '';
            updateSubmitButtonState();
        }

        function closeFeedbackModal() {
            document.getElementById('feedbackModalOverlay').classList.remove('active');
        }

        function toggleReason(btn) {
            btn.classList.toggle('selected');
            updateSubmitButtonState();
        }

        function updateSubmitButtonState() {
            const selectedChips = document.querySelectorAll('.reason-chip.selected');
            const submitBtn = document.getElementById('submitDetailedFeedback');
            if (selectedChips.length > 0) {
                submitBtn.disabled = false;
                submitBtn.classList.add('ready');
            } else {
                submitBtn.disabled = true;
                submitBtn.classList.remove('ready');
            }
        }

        async function submitDetailedFeedback() {
            const selectedChips = document.querySelectorAll('.reason-chip.selected');
            const reasons = Array.from(selectedChips).map(c => c.textContent);
            const details = document.getElementById('feedbackDetails').value;

            await submitFeedback(false, reasons, details);

            closeFeedbackModal();
            document.getElementById('feedbackMsg').style.display = 'block';
            document.getElementById('feedbackMsg').textContent = 'Thank you for your detailed feedback!';
            document.getElementById('feedbackDown').classList.add('active-down');
            document.getElementById('feedbackUp').classList.remove('active-up');
            document.getElementById('feedbackUp').disabled = true;
            document.getElementById('feedbackDown').disabled = true;
        }

        async function submitFeedback(isPositive, reasons = [], details = '') {
            const token = localStorage.getItem('token');

            try {
                const response = await fetch('/api/feedback', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        content_id: currentLeadId,
                        content_type: 'lead',
                        is_positive: isPositive,
                        reasons: reasons,
                        details: details
                    })
                });

                return response.ok;
            } catch (error) {
                console.error('Error submitting feedback:', error);
                return false;
            }
        }

        function determineSalesApproach(category, authority, budget) {
            if (category === 'Hot') {
                return {
                    approach: 'Consultative / Executive-focused',
                    messaging: authority === 'Primary Decision Maker' ? 'ROI and strategic impact metrics' : 'Operational efficiency and peer validation',
                    engagement: 'Schedule executive-level demo within 24 hours'
                };
            } else if (category === 'Warm') {
                return {
                    approach: 'Value-driven / Needs assessment',
                    messaging: 'Business case development and competitive differentiation',
                    engagement: 'Conduct discovery call to refine business case within 3 days'
                };
            } else {
                return {
                    approach: 'Nurture / Content-driven',
                    messaging: 'Industry insights and thought leadership resources',
                    engagement: 'Add to nurture sequence; revisit quarterly or upon trigger events'
                };
            }
        }

        window.closeLeadOutput = function () {
            document.getElementById('leadOutput').style.display = 'none';
            document.getElementById('placeholderCard').style.display = 'block';
            document.getElementById('leadForm').reset();
        }
        document.addEventListener('DOMContentLoaded', () => {
        });
    </script>
</body>

</html>