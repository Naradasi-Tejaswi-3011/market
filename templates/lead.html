<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lead Scorer - MarketAI Suite</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand">
            <h1><span class="logo-icon"></span> MarketAI Suite</h1>
        </div>
        <div class="nav-menu">
            <a href="/" class="nav-link">Home</a>
            <a href="/campaign" class="nav-link">Campaigns</a>
            <a href="/pitch" class="nav-link">Pitches</a>
            <a href="/lead" class="nav-link active">Leads</a>
            <button id="logoutBtn" class="btn btn-logout">Logout</button>
        </div>
    </nav>
    
    <main class="container">
        <div class="page-header">
            <h2>‚≠ê Lead Scoring System</h2>
            <p>Intelligent lead qualification with detailed reasoning</p>
        </div>
        
        <div class="content-grid">
            <!-- Input Form -->
            <div class="form-section">
                <h3>Lead Profile</h3>
                <form id="leadForm" class="form-group">
                    <div>
                        <label for="budget">Budget *</label>
                        <select id="budget" name="budget" required>
                            <option value="">Select budget...</option>
                            <option value="Under $50K">Under $50K</option>
                            <option value="$50K - $150K">$50K - $150K</option>
                            <option value="$150K - $500K">$150K - $500K</option>
                            <option value="$500K - $1M">$500K - $1M</option>
                            <option value="Over $1M">Over $1M</option>
                            <option value="Unknown">Unknown</option>
                        </select>
                    </div>
                    
                    <div>
                        <label for="business_need">Business Need *</label>
                        <input 
                            type="text" 
                            id="business_need" 
                            name="business_need" 
                            placeholder="e.g., Inventory management, marketing automation"
                            required
                        >
                    </div>
                    
                    <div>
                        <label for="urgency">Urgency *</label>
                        <select id="urgency" name="urgency" required>
                            <option value="">Select urgency...</option>
                            <option value="High - Need immediately">High - Need immediately</option>
                            <option value="Medium - Within 3 months">Medium - Within 3 months</option>
                            <option value="Low - 6+ months">Low - 6+ months</option>
                            <option value="Exploring options">Exploring options</option>
                        </select>
                    </div>
                    
                    <div>
                        <label for="authority">Authority Level *</label>
                        <select id="authority" name="authority" required>
                            <option value="">Select authority...</option>
                            <option value="Primary Decision Maker">Primary Decision Maker</option>
                            <option value="Budget Approver">Budget Approver</option>
                            <option value="Technical Influencer">Technical Influencer</option>
                            <option value="End User">End User</option>
                        </select>
                    </div>
                    
                    <div>
                        <label for="industry">Industry *</label>
                        <select id="industry" name="industry" required>
                            <option value="">Select industry...</option>
                            <option value="SaaS">SaaS</option>
                            <option value="Healthcare">Healthcare</option>
                            <option value="EdTech">EdTech</option>
                            <option value="Retail">Retail</option>
                            <option value="FinTech">FinTech</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    
                    <button type="submit" class="btn btn-primary btn-block">
                        Score Lead
                    </button>
                </form>
                
                <div id="formMessage" class="message"></div>
            </div>
            
            <!-- Output Results -->
            <div class="results-section">
                <div id="loadingSpinner" class="spinner" style="display: none;">
                    <div class="spinner-content">
                        <div class="spinner-circle"></div>
                        <p>Analyzing lead profile...</p>
                    </div>
                </div>
                
                <div id="leadOutput" style="display: none;">
                    <h3>üìä Lead Assessment</h3>
                    
                    <!-- Overall Lead Qualification Score -->
                    <div class="output-card lead-score-card">
                        <h4>Overall Lead Qualification Score</h4>
                        <div class="score-display-large">
                            <div class="score-circle-large" id="scoreCircle">0</div>
                            <div class="score-label">
                                <p id="scoreTierText" class="category-tier"></p>
                                <p id="scoreIntentText" class="intent-text"></p>
                                <p id="conversionProb" class="conversion"></p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Lead Snapshot Section -->
                    <div class="output-card lead-snapshot">
                        <h4>üì∏ Lead Snapshot</h4>
                        <div class="snapshot-grid">
                            <div class="snapshot-item">
                                <strong>Industry</strong>
                                <p id="snapshotIndustry">‚Äî</p>
                            </div>
                            <div class="snapshot-item">
                                <strong>Budget Range</strong>
                                <p id="snapshotBudget">‚Äî</p>
                            </div>
                            <div class="snapshot-item">
                                <strong>Urgency Level</strong>
                                <p id="snapshotUrgency">‚Äî</p>
                            </div>
                            <div class="snapshot-item">
                                <strong>Authority Level</strong>
                                <p id="snapshotAuthority">‚Äî</p>
                            </div>
                        </div>
                        <div class="snapshot-need">
                            <strong>Business Need Summary</strong>
                            <p id="snapshotNeed">‚Äî</p>
                        </div>
                    </div>
                    
                    <!-- Detailed Analysis Section -->
                    <div class="output-card">
                        <h4>üî¨ Detailed Analysis</h4>
                        <div id="detailedReasoning" class="reasoning-section"></div>
                    </div>
                    
                    <div class="output-card">
                        <h4>üìà Score Breakdown</h4>
                        <div id="scoreBreakdown" class="score-breakdown"></div>
                    </div>
                    
                    <!-- Risk Factors with Color-Coded Level -->
                    <div class="output-card">
                        <h4>‚ö†Ô∏è Risk Assessment</h4>
                        <div class="risk-level-container">
                            <p><strong>Risk Level:</strong> <span id="riskLevel" class="risk-badge"></span></p>
                        </div>
                        <div id="riskFactors" class="risk-list"></div>
                    </div>
                    
                    <!-- Sales Strategy Section -->
                    <div class="output-card sales-strategy">
                        <h4>üéØ Recommended Sales Strategy</h4>
                        <div id="salesStrategy" class="strategy-content"></div>
                    </div>
                    
                    <div class="output-card">
                        <h4>ÔøΩ Priority Recommendation</h4>
                        <p id="priorityRec" class="priority-rec"></p>
                    </div>
                    
                    <!-- Explainability Section -->
                    <div class="output-card explainability">
                        <h4>üîç Scoring Factors Considered:</h4>
                        <ul>
                            <li>Budget capacity relative to industry benchmarks</li>
                            <li>Business need definition and clarity</li>
                            <li>Timeline and procurement urgency signals</li>
                            <li>Decision-making authority and influence level</li>
                            <li>Industry-specific conversion and fit patterns</li>
                        </ul>
                        <p class="disclaimer">‚ö†Ô∏è AI-assisted qualification. Human sales judgment remains essential for final assessment.</p>
                    </div>
                    
                    <!-- Recommended Actions -->
                    <div class="output-card recommended-actions">
                        <h4>üìå Recommended Next Actions:</h4>
                        <div id="nextActions"></div>
                    </div>
                    
                    <button id="scoreLeadBtn" class="btn btn-success">
                        ‚úì Save Scoring
                    </button>
                </div>
                
                <div id="previousLeads" class="previous-outputs">
                    <h4>Previous Leads</h4>
                    <div id="leadList" class="output-list"></div>
                </div>
            </div>
        </div>
    </main>
    
    <footer class="footer">
        <p>&copy; 2026 MarketAI Suite - Explainable AI for Business Intelligence</p>
    </footer>
    
    <script src="{{ url_for('static', filename='app.js') }}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', checkAuth);
        document.getElementById('leadForm').addEventListener('submit', scoreLead);
        document.getElementById('logoutBtn').addEventListener('click', logout);
        
        async function scoreLead(e) {
            e.preventDefault();
            
            const token = localStorage.getItem('token');
            const formData = {
                budget: document.getElementById('budget').value,
                business_need: document.getElementById('business_need').value,
                urgency: document.getElementById('urgency').value,
                authority: document.getElementById('authority').value,
                industry: document.getElementById('industry').value
            };
            
            document.getElementById('loadingSpinner').style.display = 'flex';
            document.getElementById('leadOutput').style.display = 'none';
            document.getElementById('formMessage').textContent = '';
            
            try {
                const response = await fetch('/api/leads/score', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(formData)
                });
                
                const data = await response.json();
                document.getElementById('loadingSpinner').style.display = 'none';
                
                if (response.ok) {
                    displayLeadOutput(data.lead_score);
                    currentLeadId = data.lead_id;
                    await loadLeads();
                } else {
                    document.getElementById('formMessage').textContent = data.error || 'Error scoring lead';
                    document.getElementById('formMessage').classList.add('error');
                }
            } catch (error) {
                document.getElementById('loadingSpinner').style.display = 'none';
                document.getElementById('formMessage').textContent = 'Network error. Please try again.';
                document.getElementById('formMessage').classList.add('error');
            }
        }
        
        function displayLeadOutput(leadScore) {
            const score = leadScore.lead_score;
            const category = leadScore.lead_category;
            const convProb = leadScore.conversion_probability;
            
            // Score circle with color coding
            document.getElementById('scoreCircle').textContent = score;
            const color = category === 'Hot' ? '#10b981' : category === 'Warm' ? '#f59e0b' : '#ef4444';
            document.getElementById('scoreCircle').style.borderColor = color;
            
            // Enhanced tier display
            const tierMap = {
                'Hot': { tier: 'A', intent: 'High buying intent. Immediate prioritization recommended.' },
                'Warm': { tier: 'B', intent: 'Moderate interest with positive indicators. Follow up within 48 hours.' },
                'Cold': { tier: 'C', intent: 'Limited immediate interest. Nurture for future opportunity.' }
            };
            
            const tierInfo = tierMap[category] || tierMap['Warm'];
            document.getElementById('scoreTierText').innerHTML = `üî• ${category} Lead (Tier ${tierInfo.tier})`;
            document.getElementById('scoreIntentText').textContent = tierInfo.intent;
            document.getElementById('conversionProb').textContent = `${convProb}% estimated conversion probability`;
            
            // Populate Lead Snapshot
            const formData = {
                industry: document.getElementById('industry').value,
                budget: document.getElementById('budget').value,
                urgency: document.getElementById('urgency').value,
                authority: document.getElementById('authority').value,
                business_need: document.getElementById('business_need').value
            };
            
            document.getElementById('snapshotIndustry').textContent = formData.industry;
            document.getElementById('snapshotBudget').textContent = formData.budget;
            document.getElementById('snapshotUrgency').textContent = formData.urgency.split(' - ')[0];
            document.getElementById('snapshotAuthority').textContent = formData.authority;
            document.getElementById('snapshotNeed').textContent = formData.business_need;
            
            // Detailed reasoning - executive-level refinement
            const reasoning = leadScore.detailed_reasoning;
            document.getElementById('detailedReasoning').innerHTML = `
                <div class="reasoning-item">
                    <strong>Budget Analysis</strong>
                    <p>${reasoning.budget_analysis}</p>
                </div>
                <div class="reasoning-item">
                    <strong>Need Alignment</strong>
                    <p>${reasoning.need_alignment}</p>
                </div>
                <div class="reasoning-item">
                    <strong>Urgency Signal</strong>
                    <p>${reasoning.urgency_signal}</p>
                </div>
                <div class="reasoning-item">
                    <strong>Authority Assessment</strong>
                    <p>${reasoning.authority_assessment}</p>
                </div>
                <div class="reasoning-item">
                    <strong>Industry Context</strong>
                    <p>${reasoning.industry_context}</p>
                </div>
            `;
            
            // Score breakdown
            const breakdown = leadScore.score_breakdown;
            document.getElementById('scoreBreakdown').innerHTML = `
                <div class="breakdown-row">
                    <div class="breakdown-item-grid">
                        <label>Budget Fit: ${breakdown.budget_fit.score}/100</label>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${breakdown.budget_fit.score}%"></div>
                        </div>
                        <small>${breakdown.budget_fit.reasoning}</small>
                    </div>
                </div>
                <div class="breakdown-row">
                    <div class="breakdown-item-grid">
                        <label>Need Clarity: ${breakdown.need_clarity.score}/100</label>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${breakdown.need_clarity.score}%"></div>
                        </div>
                        <small>${breakdown.need_clarity.reasoning}</small>
                    </div>
                </div>
                <div class="breakdown-row">
                    <div class="breakdown-item-grid">
                        <label>Urgency Level: ${breakdown.urgency_level.score}/100</label>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${breakdown.urgency_level.score}%"></div>
                        </div>
                        <small>${breakdown.urgency_level.reasoning}</small>
                    </div>
                </div>
                <div class="breakdown-row">
                    <div class="breakdown-item-grid">
                        <label>Authority Level: ${breakdown.authority_level.score}/100</label>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${breakdown.authority_level.score}%"></div>
                        </div>
                        <small>${breakdown.authority_level.reasoning}</small>
                    </div>
                </div>
                <div class="breakdown-row">
                    <div class="breakdown-item-grid">
                        <label>Industry Fit: ${breakdown.industry_fit.score}/100</label>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${breakdown.industry_fit.score}%"></div>
                        </div>
                        <small>${breakdown.industry_fit.reasoning}</small>
                    </div>
                </div>
            `;
            
            // Risk Assessment with color-coded level
            const riskFactors = leadScore.risk_factors || [];
            let riskLevel = 'Low';
            let riskColor = '#10b981';
            
            if (riskFactors.length > 2) {
                riskLevel = 'High';
                riskColor = '#ef4444';
            } else if (riskFactors.length > 0) {
                riskLevel = 'Medium';
                riskColor = '#f59e0b';
            }
            
            const riskBadge = document.getElementById('riskLevel');
            riskBadge.textContent = riskLevel;
            riskBadge.style.backgroundColor = riskColor;
            riskBadge.style.color = '#fff';
            riskBadge.style.padding = '4px 12px';
            riskBadge.style.borderRadius = '4px';
            riskBadge.style.fontWeight = 'bold';
            
            document.getElementById('riskFactors').innerHTML = riskFactors.length > 0
                ? `<div class="risk-concerns"><strong>Primary Concerns:</strong><ul>${riskFactors.map(r => `<li>${r}</li>`).join('')}</ul></div>`
                : '<p class="low-risk">‚úì No significant risk factors identified</p>';
            
            // Sales Strategy Section
            const salesApproach = determineSalesApproach(category, formData.authority, formData.budget);
            document.getElementById('salesStrategy').innerHTML = `
                <div class="strategy-item">
                    <strong>Recommended Approach:</strong>
                    <p>${salesApproach.approach}</p>
                </div>
                <div class="strategy-item">
                    <strong>Key Messaging Angle:</strong>
                    <p>${salesApproach.messaging}</p>
                </div>
                <div class="strategy-item">
                    <strong>Engagement Recommendation:</strong>
                    <p>${salesApproach.engagement}</p>
                </div>
            `;
            
            // Priority recommendation
            document.getElementById('priorityRec').textContent = leadScore.priority_recommendation;
            
            // Next actions
            document.getElementById('nextActions').innerHTML = leadScore.next_actions
                .map(a => `<div class="action-item">‚Üí ${a}</div>`)
                .join('');
            
            document.getElementById('leadOutput').style.display = 'block';
        }
        
        function determineSalesApproach(category, authority, budget) {
            if (category === 'Hot') {
                return {
                    approach: 'Consultative / Executive-focused',
                    messaging: authority === 'Primary Decision Maker' ? 'ROI and strategic impact metrics' : 'Operational efficiency and peer validation',
                    engagement: 'Schedule executive-level demo within 24 hours'
                };
            } else if (category === 'Warm') {
                return {
                    approach: 'Value-driven / Needs assessment',
                    messaging: 'Business case development and competitive differentiation',
                    engagement: 'Conduct discovery call to refine business case within 3 days'
                };
            } else {
                return {
                    approach: 'Nurture / Content-driven',
                    messaging: 'Industry insights and thought leadership resources',
                    engagement: 'Add to nurture sequence; revisit quarterly or upon trigger events'
                };
            }
        }
        
        async function loadLeads() {
            const token = localStorage.getItem('token');
            
            try {
                const response = await fetch('/api/leads', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const html = data.leads.length > 0
                        ? data.leads.map((l, i) => `
                            <div class="lead-item">
                                <h5>Score: ${l.ai_output.lead_score} - ${l.ai_output.lead_category}</h5>
                                <p>${l.business_need}</p>
                                <small>${new Date(l.created_at).toLocaleString()}</small>
                            </div>
                        `).join('')
                        : '<p>No leads scored yet</p>';
                    
                    document.getElementById('leadList').innerHTML = html;
                }
            } catch (error) {
                console.error('Error loading leads:', error);
            }
        }
        
        let currentLeadId = null;
        
        document.addEventListener('DOMContentLoaded', () => {
            loadLeads();
            
            document.getElementById('scoreLeadBtn').addEventListener('click', () => {
                alert('Lead scoring saved successfully!');
            });
        });
    </script>
</body>
</html>
