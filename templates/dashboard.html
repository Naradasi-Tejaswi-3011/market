<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - MarketAI Suite</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand">
            <h1><span class="logo-icon"></span> MarketAI Suite</h1>
        </div>
        <div class="nav-menu">
            <a href="/" class="nav-link active">Home</a>
            <a href="/campaign" class="nav-link">Campaigns</a>
            <a href="/pitch" class="nav-link">Pitches</a>
            <a href="/lead" class="nav-link">Leads</a>
            <button id="logoutBtn" class="btn btn-logout">Logout</button>
        </div>
    </nav>
    
    <main class="container">
        <div class="dashboard-header">
            <h2>AI-Powered Marketing Intelligence</h2>
            <p>Generate data-driven marketing campaigns with explainable AI</p>
        </div>
        
        <div class="features-grid">
            <a href="/campaign" class="feature-card">
                <div class="feature-icon">ðŸŽ¯</div>
                <h3>AI Campaign Generator</h3>
                <p>Industry-specific marketing strategies powered by Groq AI</p>
                <span class="feature-count" id="campaignCount">âœ… Member 2 - Complete</span>
            </a>
            
            <a href="/pitch" class="feature-card">
                <div class="feature-icon">ðŸ’¬</div>
                <h3>AI Sales Pitch</h3>
                <p>Persona-aware pitch generation</p>
                <span class="feature-count" id="pitchCount" style="background: rgba(59, 130, 246, 0.1); color: #60a5fa; border-color: rgba(59, 130, 246, 0.2);">âŒ› Member 3 - Pending</span>
            </a>
            
            <a href="/lead" class="feature-card">
                <div class="feature-icon">ðŸ“Š</div>
                <h3>Lead Scoring</h3>
                <p>Intelligent lead classification</p>
                <span class="feature-count" id="leadCount" style="background: rgba(59, 130, 246, 0.1); color: #60a5fa; border-color: rgba(59, 130, 246, 0.2);">âŒ› Member 4 - Pending</span>
            </a>
        </div>
        
        <section class="recent-activity">
            <h3>Recent Activity</h3>
            <div class="activity-tabs">
                <button class="activity-tab-btn active" onclick="showActivityModal('campaigns')">
                    <span class="tab-icon">ðŸŽ¯</span>
                    <span>Campaigns</span>
                </button>
                <button class="activity-tab-btn" onclick="showActivityModal('pitches')">
                    <span class="tab-icon">ðŸ’¬</span>
                    <span>Pitches</span>
                </button>
                <button class="activity-tab-btn" onclick="showActivityModal('leads')">
                    <span class="tab-icon">ðŸ“Š</span>
                    <span>Leads</span>
                </button>
            </div>
        </section>

        <!-- Pitch View Modal -->
        <div id="pitchViewModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="modalPitchTitle">Pitch Details</h3>
                    <button type="button" class="modal-close" onclick="window.closePitchModal()" title="Close">&times;</button>
                </div>
                <div class="modal-body" id="modalPitchBody">
                    <!-- Pitch details will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Activity Details Modal -->
        <div id="activityModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="modalActivityTitle">Activity Details</h3>
                    <button type="button" class="modal-close" onclick="window.closeActivityModal()" title="Close">&times;</button>
                </div>
                <div class="modal-body" id="modalActivityBody">
                    <!-- Activity details will be loaded here -->
                </div>
            </div>
        </div>
    </main>
    
    <footer class="footer">
        <p>&copy; 2026 MarketAI Suite - Explainable AI for Business Intelligence</p>
    </footer>
    
    <script src="{{ url_for('static', filename='app.js') }}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // Check authentication
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/login';
                return;
            }
            
            // Load user info
            try {
                const response = await fetch('/api/auth/me', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) {
                    window.location.href = '/login';
                }
            } catch (error) {
                window.location.href = '/login';
            }
            
            // Load counts
            await loadCounts();
        });
        
        async function loadCounts() {
            const token = localStorage.getItem('token');
            
            try {
                const [campaignRes, pitchRes, leadRes] = await Promise.all([
                    fetch('/api/campaigns', { headers: { 'Authorization': `Bearer ${token}` } }),
                    fetch('/api/pitches', { headers: { 'Authorization': `Bearer ${token}` } }),
                    fetch('/api/leads', { headers: { 'Authorization': `Bearer ${token}` } })
                ]);
                
                if (campaignRes.ok) {
                    const data = await campaignRes.json();
                    document.getElementById('campaignCount').textContent = `${data.count} campaign${data.count !== 1 ? 's' : ''}`;
                }
                
                if (pitchRes.ok) {
                    const data = await pitchRes.json();
                    document.getElementById('pitchCount').textContent = `${data.count} pitch${data.count !== 1 ? 'es' : ''}`;
                }
                
                if (leadRes.ok) {
                    const data = await leadRes.json();
                    document.getElementById('leadCount').textContent = `${data.count} lead${data.count !== 1 ? 's' : ''}`;
                }
            } catch (error) {
                console.error('Error loading counts:', error);
            }
        }
        
        async function showActivityModal(type) {
            const token = localStorage.getItem('token');
            
            // Update tab buttons
            document.querySelectorAll('.activity-tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.closest('.activity-tab-btn').classList.add('active');
            
            try {
                if (type === 'campaigns') {
                    const response = await fetch('/api/campaigns', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        const campaigns = data.campaigns || [];
                        displayCampaignsModal(campaigns);
                        document.getElementById('activityModal').style.display = 'flex';
                    }
                } else if (type === 'pitches') {
                    const response = await fetch('/api/pitches', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        const pitches = data.pitches || [];
                        displayPitchesModal(pitches);
                        document.getElementById('activityModal').style.display = 'flex';
                    }
                } else if (type === 'leads') {
                    const response = await fetch('/api/leads', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        const leads = data.leads || [];
                        displayLeadsModal(leads);
                        document.getElementById('activityModal').style.display = 'flex';
                    }
                }
            } catch (error) {
                console.error('Error loading activity:', error);
            }
        }
        
        function displayCampaignsModal(campaigns) {
            document.getElementById('modalActivityTitle').textContent = 'Campaigns';
            
            if (campaigns.length === 0) {
                document.getElementById('modalActivityBody').innerHTML = '<p style="text-align: center; padding: 2rem;">No campaigns yet. <a href="/campaign">Create your first campaign</a></p>';
            } else {
                const campaignHtml = campaigns.map(c => `
                    <div class="activity-modal-item campaign-modal-item" onclick="viewCampaignDetails('${c._id}', event)">
                        <div class="activity-modal-header">
                            <div>
                                <strong>${c.product}</strong>
                                <p class="campaign-subtitle-small">${c.platform} | ${c.industry}</p>
                            </div>
                            <span class="activity-timestamp">${new Date(c.created_at).toLocaleDateString()}</span>
                        </div>
                    </div>
                `).join('');
                
                document.getElementById('modalActivityBody').innerHTML = `<div class="activity-modal-list">${campaignHtml}</div>`;
            }
        }
        
        function displayPitchesModal(pitches) {
            document.getElementById('modalActivityTitle').textContent = 'Pitches';
            
            if (pitches.length === 0) {
                document.getElementById('modalActivityBody').innerHTML = '<p style="text-align: center; padding: 2rem;">No pitches yet. <a href="/pitch">Create your first pitch</a></p>';
            } else {
                const pitchHtml = pitches.map(p => `
                    <div class="activity-modal-item pitch-modal-item" onclick="viewPitchFromHistory('${p._id}', event)">
                        <div class="activity-modal-header">
                            <div>
                                <strong>${p.product} â†’ ${p.persona}</strong>
                                <p class="pitch-subtitle-small">${p.industry} | ${p.customer_type}</p>
                            </div>
                            <span class="activity-timestamp">${new Date(p.created_at).toLocaleDateString()}</span>
                        </div>
                    </div>
                `).join('');
                
                document.getElementById('modalActivityBody').innerHTML = `<div class="activity-modal-list">${pitchHtml}</div>`;
            }
        }
        
        function displayActivityModal(type, activities) {
            const titleMap = {
                campaigns: 'Campaign Activity',
                pitches: 'Pitch Activity',
                leads: 'Lead Activity'
            };
            
            document.getElementById('modalActivityTitle').textContent = titleMap[type];
            
            if (activities.length === 0) {
                document.getElementById('modalActivityBody').innerHTML = '<p style="text-align: center; padding: 2rem;">No activities yet for this category</p>';
            } else {
                const activityHtml = activities.map(a => `
                    <div class="activity-modal-item">
                        <div class="activity-modal-header">
                            <strong>${a.action.replace(/_/g, ' ').toUpperCase()}</strong>
                            <span class="activity-timestamp">${new Date(a.created_at).toLocaleString()}</span>
                        </div>
                    </div>
                `).join('');
                
                document.getElementById('modalActivityBody').innerHTML = `<div class="activity-modal-list">${activityHtml}</div>`;
            }
        }
        
        function displayLeadsModal(leads) {
            document.getElementById('modalActivityTitle').textContent = 'Leads';
            
            if (leads.length === 0) {
                document.getElementById('modalActivityBody').innerHTML = '<p style="text-align: center; padding: 2rem;">No leads yet. <a href="/lead">Score your first lead</a></p>';
            } else {
                const leadHtml = leads.map(l => `
                    <div class="activity-modal-item lead-modal-item" onclick="viewLeadDetails('${l._id}', event)">
                        <div class="activity-modal-header">
                            <div>
                                <strong>${l.business_need} - ${l.budget}</strong>
                                <p class="lead-subtitle-small">${l.industry} | ${l.authority}</p>
                            </div>
                            <span class="activity-timestamp">${new Date(l.created_at).toLocaleDateString()}</span>
                        </div>
                    </div>
                `).join('');
                
                document.getElementById('modalActivityBody').innerHTML = `<div class="activity-modal-list">${leadHtml}</div>`;
            }
        }
        
        window.closeActivityModal = function() {
            document.getElementById('activityModal').style.display = 'none';
        }

        window.closePitchModal = function() {
            document.getElementById('pitchViewModal').style.display = 'none';
        }
        
        document.getElementById('logoutBtn').addEventListener('click', () => {
            localStorage.removeItem('token');
            localStorage.removeItem('user_id');
            localStorage.removeItem('email');
            window.location.href = '/login';
        });

        async function viewPitchFromHistory(pitchId, event) {
            event.preventDefault();
            event.stopPropagation();
            const token = localStorage.getItem('token');
            
            try {
                const response = await fetch(`/api/pitches/${pitchId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const pitchData = await response.json();
                    displayPitchModal(pitchData);
                    document.getElementById('activityModal').style.display = 'none';
                    document.getElementById('pitchViewModal').style.display = 'flex';
                }
            } catch (error) {
                console.error('Error fetching pitch:', error);
            }
        }

        async function viewCampaignDetails(campaignId, event) {
            event.preventDefault();
            event.stopPropagation();
            const token = localStorage.getItem('token');
            
            try {
                const response = await fetch(`/api/campaigns/${campaignId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const campaignData = await response.json();
                    displayCampaignDetail(campaignData);
                    document.getElementById('activityModal').style.display = 'none';
                    document.getElementById('pitchViewModal').style.display = 'flex';
                }
            } catch (error) {
                console.error('Error fetching campaign:', error);
            }
        }

        async function viewLeadDetails(leadId, event) {
            event.preventDefault();
            event.stopPropagation();
            const token = localStorage.getItem('token');
            
            try {
                const response = await fetch(`/api/leads/${leadId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const leadData = await response.json();
                    displayLeadDetail(leadData);
                    document.getElementById('activityModal').style.display = 'none';
                    document.getElementById('pitchViewModal').style.display = 'flex';
                }
            } catch (error) {
                console.error('Error fetching lead:', error);
            }
        }

        function displayPitchModal(pitchData) {
            const modalTitle = `${pitchData.product} â†’ ${pitchData.persona}`;
            document.getElementById('modalPitchTitle').textContent = modalTitle;
            
            const pitch = pitchData.ai_output;
            const modalBody = `
                <div class="pitch-modal-content">
                    <div class="pitch-info">
                        <div class="info-row">
                            <strong>Industry:</strong> <span>${pitchData.industry}</span>
                        </div>
                        <div class="info-row">
                            <strong>Customer Type:</strong> <span>${pitchData.customer_type}</span>
                        </div>
                        <div class="info-row">
                            <strong>Budget Preference:</strong> <span>${pitchData.budget_preference}</span>
                        </div>
                        <div class="info-row">
                            <strong>Created:</strong> <span>${new Date(pitchData.created_at).toLocaleString()}</span>
                        </div>
                    </div>
                    
                    <hr class="section-divider">
                    
                    <div class="pitch-section">
                        <h4>Elevator Pitch</h4>
                        <p>${pitch.elevator_pitch}</p>
                    </div>
                    
                    <div class="pitch-section">
                        <h4>Value Proposition</h4>
                        <p>${pitch.value_proposition}</p>
                    </div>
                    
                    <div class="pitch-section">
                        <h4>Key Differentiators</h4>
                        <ul class="pitch-list">
                            ${pitch.key_differentiators.map(d => `<li>${d}</li>`).join('')}
                        </ul>
                    </div>
                    
                    <div class="pitch-section">
                        <h4>Call to Action</h4>
                        <p>${pitch.personalized_cta}</p>
                    </div>
                </div>
            `;
            
            document.getElementById('modalPitchBody').innerHTML = modalBody;
        }

        function displayCampaignDetail(campaignData) {
            const modalTitle = `${campaignData.product} - ${campaignData.platform}`;
            document.getElementById('modalPitchTitle').textContent = modalTitle;
            
            const campaign = campaignData.ai_output;
            const ideas = campaign.campaign_ideas || [];
            const ctas = campaign.cta_suggestions || [];
            const calendar = campaign.content_calendar || [];
            
            const modalBody = `
                <div class="pitch-modal-content">
                    <div class="pitch-info">
                        <div class="info-row">
                            <strong>Platform:</strong> <span>${campaignData.platform}</span>
                        </div>
                        <div class="info-row">
                            <strong>Industry:</strong> <span>${campaignData.industry}</span>
                        </div>
                        <div class="info-row">
                            <strong>Audience:</strong> <span>${campaignData.audience}</span>
                        </div>
                        <div class="info-row">
                            <strong>Created:</strong> <span>${new Date(campaignData.created_at).toLocaleString()}</span>
                        </div>
                    </div>
                    
                    <hr class="section-divider">
                    
                    <div class="pitch-section">
                        <h4>Campaign Ideas</h4>
                        ${ideas.length > 0 ? ideas.map(idea => `
                            <div style="margin-bottom: 1rem; padding: 0.75rem; background: var(--bg-tertiary); border-radius: 0.5rem;">
                                <strong>${idea.title}</strong>
                                <p style="margin: 0.5rem 0 0 0; color: #cbd5e1;">${idea.description}</p>
                            </div>
                        `).join('') : '<p>No campaign ideas</p>'}
                    </div>
                    
                    <hr class="section-divider">
                    
                    <div class="pitch-section">
                        <h4>Call to Actions</h4>
                        ${ctas.length > 0 ? ctas.map(cta => `
                            <div style="margin-bottom: 0.75rem; padding: 0.75rem; background: var(--bg-tertiary); border-radius: 0.5rem;">
                                <strong>${cta.cta_text}</strong>
                                <p style="margin: 0.25rem 0 0 0; font-size: 0.875rem; color: #cbd5e1;">${cta.description}</p>
                            </div>
                        `).join('') : '<p>No CTAs</p>'}
                    </div>
                    
                    <hr class="section-divider">
                    
                    <div class="pitch-section">
                        <h4>Content Calendar (7 Days)</h4>
                        ${calendar.length > 0 ? calendar.map(day => `
                            <div style="margin-bottom: 0.75rem; padding: 0.75rem; background: var(--bg-tertiary); border-radius: 0.5rem;">
                                <strong>Day ${day.day} - ${day.post_type}</strong>
                                <p style="margin: 0.25rem 0 0 0; font-size: 0.875rem; color: #cbd5e1;">${day.content_idea}</p>
                                <p style="margin: 0.25rem 0 0 0; font-size: 0.8rem; color: #64748b;">Best Time: ${day.best_time}</p>
                            </div>
                        `).join('') : '<p>No calendar data</p>'}
                    </div>
                </div>
            `;
            
            document.getElementById('modalPitchBody').innerHTML = modalBody;
        }

        function displayLeadDetail(leadData) {
            const modalTitle = `Lead - ${leadData.business_need}`;
            document.getElementById('modalPitchTitle').textContent = modalTitle;
            
            const leadAI = leadData.ai_output || {};
            
            // Get lead score - handle both structures
            const leadScore = leadData.lead_score || leadAI.lead_score || 'N/A';
            const leadCat = leadData.lead_category || leadAI.lead_category || 'Unrated';
            const convProb = leadData.conversion_probability || leadAI.conversion_probability || 'N/A';
            const reasoning = leadData.detailed_reasoning || leadAI.detailed_reasoning || {};
            
            const modalBody = `
                <div class="pitch-modal-content">
                    <div class="pitch-info">
                        <div class="info-row">
                            <strong>Business Need:</strong> <span>${leadData.business_need}</span>
                        </div>
                        <div class="info-row">
                            <strong>Budget:</strong> <span>${leadData.budget}</span>
                        </div>
                        <div class="info-row">
                            <strong>Industry:</strong> <span>${leadData.industry}</span>
                        </div>
                        <div class="info-row">
                            <strong>Urgency:</strong> <span>${leadData.urgency}</span>
                        </div>
                        <div class="info-row">
                            <strong>Authority:</strong> <span>${leadData.authority}</span>
                        </div>
                        <div class="info-row">
                            <strong>Created:</strong> <span>${new Date(leadData.created_at).toLocaleString()}</span>
                        </div>
                    </div>
                    
                    <hr class="section-divider">
                    
                    <div class="pitch-section">
                        <h4>Lead Quality Score</h4>
                        <div style="padding: 1.5rem; background: var(--bg-tertiary); border-radius: 0.5rem; text-align: center;">
                            <div style="font-size: 2.5rem; font-weight: bold; color: var(--primary); margin-bottom: 0.5rem;">
                                ${leadScore}${leadScore !== 'N/A' ? '%' : ''}
                            </div>
                            <p style="margin: 0.5rem 0 0 0; color: #cbd5e1;"><strong>Category:</strong> ${leadCat}</p>
                            <p style="margin: 0.25rem 0 0 0; color: #cbd5e1;">Conversion Probability: ${convProb}${convProb !== 'N/A' ? '%' : ''}</p>
                        </div>
                    </div>
                    
                    <hr class="section-divider">
                    
                    <div class="pitch-section">
                        <h4>Analysis</h4>
                        ${reasoning.budget_analysis ? `<div style="margin-bottom: 0.75rem;">
                            <strong>Budget Analysis:</strong>
                            <p style="margin: 0.25rem 0 0 0; font-size: 0.9rem; color: #cbd5e1;">${reasoning.budget_analysis}</p>
                        </div>` : ''}
                        ${reasoning.need_alignment ? `<div style="margin-bottom: 0.75rem;">
                            <strong>Need Alignment:</strong>
                            <p style="margin: 0.25rem 0 0 0; font-size: 0.9rem; color: #cbd5e1;">${reasoning.need_alignment}</p>
                        </div>` : ''}
                        ${reasoning.urgency_signal ? `<div style="margin-bottom: 0.75rem;">
                            <strong>Urgency Signal:</strong>
                            <p style="margin: 0.25rem 0 0 0; font-size: 0.9rem; color: #cbd5e1;">${reasoning.urgency_signal}</p>
                        </div>` : ''}
                        ${reasoning.authority_assessment ? `<div style="margin-bottom: 0.75rem;">
                            <strong>Authority Assessment:</strong>
                            <p style="margin: 0.25rem 0 0 0; font-size: 0.9rem; color: #cbd5e1;">${reasoning.authority_assessment}</p>
                        </div>` : ''}
                        ${!reasoning.budget_analysis ? '<p style="color: #cbd5e1;">Assessment pending...</p>' : ''}
                    </div>
                </div>
            `;
            
            document.getElementById('modalPitchBody').innerHTML = modalBody;
        }

        // Close modals when clicking outside of them
        window.addEventListener('click', (event) => {
            const pitchModal = document.getElementById('pitchViewModal');
            const activityModal = document.getElementById('activityModal');
            
            if (event.target === pitchModal) {
                pitchModal.style.display = 'none';
            }
            if (event.target === activityModal) {
                activityModal.style.display = 'none';
            }
        });
    </script>
</body>
</html>
