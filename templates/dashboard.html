<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - MarketAI Suite</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>

<body>
    <nav class="navbar">
        <div class="nav-brand">
            <h1><span class="logo-icon"></span> MarketAI Suite</h1>
        </div>
        <div class="nav-menu">
            <a href="/" class="nav-link active">Home</a>
            <a href="/campaign" class="nav-link">Campaigns</a>
            <a href="/pitch" class="nav-link">Pitches</a>
            <a href="/lead" class="nav-link">Leads</a>
            <a href="/social-media" class="nav-link">Post Creation</a>
            <button id="logoutBtn" class="btn btn-logout">Logout</button>
        </div>
    </nav>

    <main class="container">
        <div class="dashboard-header">
            <h2>AI-Powered Marketing Intelligence</h2>
            <p>Generate data-driven marketing campaigns with explainable AI</p>
        </div>

        <div class="features-grid">
            <a href="/campaign" class="feature-card">
                <div class="feature-icon">üéØ</div>
                <h3>AI Campaign Generator</h3>
                <p>Industry-specific marketing strategies powered by Groq AI</p>
                <span class="feature-count" id="campaignCount">Loading...</span>
            </a>

            <a href="/pitch" class="feature-card">
                <div class="feature-icon">üí¨</div>
                <h3>AI Sales Pitch</h3>
                <p>Persona-aware pitch generation</p>
                <span class="feature-count" id="pitchCount">Loading...</span>
            </a>

            <a href="/lead" class="feature-card">
                <div class="feature-icon">üìä</div>
                <h3>Lead Scoring</h3>
                <p>Intelligent lead qualification</p>
                <span class="feature-count" id="leadCount">Loading...</span>
            </a>

            <a href="/social-media" class="feature-card">
                <div class="feature-icon">üì±</div>
                <h3>Post Creation</h3>
                <p>Generate viral captions and AI posters</p>
                <span class="feature-count" id="socialCount">Loading...</span>
            </a>
        </div>

        <section class="recent-activity">
            <h3>Recent Activity</h3>
            <div class="activity-tabs">
                <button class="activity-tab-btn active" onclick="showActivityModal('campaigns')">
                    <span class="tab-icon">üéØ</span>
                    <span>Campaigns</span>
                </button>
                <button class="activity-tab-btn" onclick="showActivityModal('pitches')">
                    <span class="tab-icon">üí¨</span>
                    <span>Pitches</span>
                </button>
                <button class="activity-tab-btn" onclick="showActivityModal('leads')">
                    <span class="tab-icon">üìä</span>
                    <span>Leads</span>
                </button>
                <button class="activity-tab-btn" onclick="showActivityModal('social')">
                    <span class="tab-icon">üì±</span>
                    <span>Post Creation</span>
                </button>
            </div>
        </section>

        <!-- Pitch View Modal -->
        <div id="pitchViewModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="modalPitchTitle">Pitch Details</h3>
                    <button class="modal-close" onclick="closePitchModal()">&times;</button>
                </div>
                <div class="modal-body" id="modalPitchBody">
                    <!-- Pitch details will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Activity Details Modal -->
        <div id="activityModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="modalActivityTitle">Activity Details</h3>
                    <button class="modal-close" onclick="closeActivityModal()">&times;</button>
                </div>
                <div class="modal-body" id="modalActivityBody">
                    <!-- Activity details will be loaded here -->
                </div>
            </div>
        </div>
    </main>

    <footer class="footer">
        <p>&copy; 2026 MarketAI Suite - Explainable AI for Business Intelligence</p>
    </footer>

    <script src="{{ url_for('static', filename='app.js') }}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // Check authentication
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/login';
                return;
            }

            // Load user info
            try {
                const response = await fetch('/api/auth/me', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    window.location.href = '/login';
                }
            } catch (error) {
                window.location.href = '/login';
            }

            // Load counts
            await loadCounts();
        });

        async function loadCounts() {
            const token = localStorage.getItem('token');

            try {
                const [campaignRes, pitchRes, leadRes, socialRes] = await Promise.all([
                    fetch('/api/campaigns', { headers: { 'Authorization': `Bearer ${token}` } }),
                    fetch('/api/pitches', { headers: { 'Authorization': `Bearer ${token}` } }),
                    fetch('/api/leads', { headers: { 'Authorization': `Bearer ${token}` } }),
                    fetch('/api/social-media', { headers: { 'Authorization': `Bearer ${token}` } })
                ]);

                if (campaignRes.ok) {
                    const data = await campaignRes.json();
                    document.getElementById('campaignCount').textContent = `${data.count} campaign${data.count !== 1 ? 's' : ''}`;
                }

                if (pitchRes.ok) {
                    const data = await pitchRes.json();
                    document.getElementById('pitchCount').textContent = `${data.count} pitch${data.count !== 1 ? 'es' : ''}`;
                }

                if (leadRes.ok) {
                    const data = await leadRes.json();
                    document.getElementById('leadCount').textContent = `${data.count} lead${data.count !== 1 ? 's' : ''}`;
                }

                if (socialRes.ok) {
                    const data = await socialRes.json();
                    const count = data.posts ? data.posts.length : 0;
                    document.getElementById('socialCount').textContent = `${count} post${count !== 1 ? 's' : ''}`;
                }
            } catch (error) {
                console.error('Error loading counts:', error);
            }
        }

        async function showActivityModal(type) {
            const token = localStorage.getItem('token');

            // Update tab buttons
            document.querySelectorAll('.activity-tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.closest('.activity-tab-btn').classList.add('active');

            try {
                if (type === 'campaigns') {
                    const response = await fetch('/api/campaigns', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        const campaigns = data.campaigns || [];
                        displayCampaignsModal(campaigns);
                        document.getElementById('activityModal').style.display = 'flex';
                    }
                } else if (type === 'pitches') {
                    const response = await fetch('/api/pitches', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        const pitches = data.pitches || [];
                        displayPitchesModal(pitches);
                        document.getElementById('activityModal').style.display = 'flex';
                    }
                } else if (type === 'leads') {
                    const response = await fetch('/api/leads', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        const leads = data.leads || [];
                        displayLeadsModal(leads);
                        document.getElementById('activityModal').style.display = 'flex';
                    }
                } else if (type === 'social') {
                    const response = await fetch('/api/social-media', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        const posts = data.posts || [];
                        displaySocialModal(posts);
                        document.getElementById('activityModal').style.display = 'flex';
                    }
                }
            } catch (error) {
                console.error('Error loading activity:', error);
            }
        }

        function displayCampaignsModal(campaigns) {
            document.getElementById('modalActivityTitle').textContent = 'Campaigns';

            if (campaigns.length === 0) {
                document.getElementById('modalActivityBody').innerHTML = '<p style="text-align: center; padding: 2rem;">No campaigns yet. <a href="/campaign">Create your first campaign</a></p>';
            } else {
                const campaignHtml = campaigns.map(c => `
                    <div class="activity-modal-item campaign-modal-item" onclick="viewCampaignDetails('${c._id}', event)">
                        <div class="activity-modal-header">
                            <div>
                                <strong>${c.product}</strong>
                                <p class="campaign-subtitle-small">${c.platform} | ${c.industry}</p>
                            </div>
                            <span class="activity-timestamp">${new Date(c.created_at).toLocaleDateString()}</span>
                        </div>
                    </div>
                `).join('');

                document.getElementById('modalActivityBody').innerHTML = `<div class="activity-modal-list">${campaignHtml}</div>`;
            }
        }

        function displayPitchesModal(pitches) {
            document.getElementById('modalActivityTitle').textContent = 'Pitches';

            if (pitches.length === 0) {
                document.getElementById('modalActivityBody').innerHTML = '<p style="text-align: center; padding: 2rem;">No pitches yet. <a href="/pitch">Create your first pitch</a></p>';
            } else {
                const pitchHtml = pitches.map(p => `
                    <div class="activity-modal-item pitch-modal-item" onclick="viewPitchFromHistory('${p._id}', event)">
                        <div class="activity-modal-header">
                            <div>
                                <strong>${p.product} ‚Üí ${p.persona}</strong>
                                <p class="pitch-subtitle-small">${p.industry} | ${p.customer_type}</p>
                            </div>
                            <span class="activity-timestamp">${new Date(p.created_at).toLocaleDateString()}</span>
                        </div>
                    </div>
                `).join('');

                document.getElementById('modalActivityBody').innerHTML = `<div class="activity-modal-list">${pitchHtml}</div>`;
            }
        }

        function displayActivityModal(type, activities) {
            const titleMap = {
                campaigns: 'Campaign Activity',
                pitches: 'Pitch Activity',
                leads: 'Lead Activity'
            };

            document.getElementById('modalActivityTitle').textContent = titleMap[type];

            if (activities.length === 0) {
                document.getElementById('modalActivityBody').innerHTML = '<p style="text-align: center; padding: 2rem;">No activities yet for this category</p>';
            } else {
                const activityHtml = activities.map(a => `
                    <div class="activity-modal-item">
                        <div class="activity-modal-header">
                            <strong>${a.action.replace(/_/g, ' ').toUpperCase()}</strong>
                            <span class="activity-timestamp">${new Date(a.created_at).toLocaleString()}</span>
                        </div>
                    </div>
                `).join('');

                document.getElementById('modalActivityBody').innerHTML = `<div class="activity-modal-list">${activityHtml}</div>`;
            }
        }

        function displayLeadsModal(leads) {
            document.getElementById('modalActivityTitle').textContent = 'Leads';

            if (leads.length === 0) {
                document.getElementById('modalActivityBody').innerHTML = '<p style="text-align: center; padding: 2rem;">No leads yet. <a href="/lead">Score your first lead</a></p>';
            } else {
                const leadHtml = leads.map(l => `
                    <div class="activity-modal-item lead-modal-item" onclick="viewLeadDetails('${l._id}', event)">
                        <div class="activity-modal-header">
                            <div>
                                <strong>${l.business_need} - ${l.budget}</strong>
                                <p class="lead-subtitle-small">${l.industry} | ${l.authority}</p>
                            </div>
                            <span class="activity-timestamp">${new Date(l.created_at).toLocaleDateString()}</span>
                        </div>
                    </div>
                `).join('');

                document.getElementById('modalActivityBody').innerHTML = `<div class="activity-modal-list">${leadHtml}</div>`;
            }
        }

        function displaySocialModal(posts) {
            document.getElementById('modalActivityTitle').textContent = 'Created Posts';

            if (posts.length === 0) {
                document.getElementById('modalActivityBody').innerHTML = '<p style="text-align: center; padding: 2rem;">No posts yet. <a href="/social-media">Create your first post</a></p>';
            } else {
                const postHtml = posts.map(p => `
                    <div class="activity-modal-item social-modal-item" onclick="viewSocialFromHistory('${p._id}', event)">
                        <div class="activity-modal-header">
                            <div>
                                <strong>${p.product}</strong>
                                <p class="social-subtitle-small">Dept: ${p.dept}</p>
                            </div>
                            <span class="activity-timestamp">${new Date(p.created_at).toLocaleDateString()}</span>
                        </div>
                    </div>
                `).join('');

                document.getElementById('modalActivityBody').innerHTML = `<div class="activity-modal-list">${postHtml}</div>`;
            }
        }

        function closeActivityModal() {
            document.getElementById('activityModal').style.display = 'none';
        }

        document.getElementById('logoutBtn').addEventListener('click', () => {
            localStorage.removeItem('token');
            localStorage.removeItem('user_id');
            localStorage.removeItem('email');
            window.location.href = '/login';
        });

        async function viewPitchFromHistory(pitchId, event) {
            event.preventDefault();
            event.stopPropagation();
            const token = localStorage.getItem('token');

            try {
                const response = await fetch(`/api/pitches/${pitchId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const pitchData = await response.json();
                    displayPitchModal(pitchData);
                    document.getElementById('activityModal').style.display = 'none';
                    document.getElementById('pitchViewModal').style.display = 'flex';
                }
            } catch (error) {
                console.error('Error fetching pitch:', error);
            }
        }

        async function viewCampaignDetails(campaignId, event) {
            event.preventDefault();
            event.stopPropagation();
            const token = localStorage.getItem('token');

            try {
                const response = await fetch(`/api/campaigns/${campaignId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const campaignData = await response.json();
                    displayCampaignDetail(campaignData);
                    document.getElementById('activityModal').style.display = 'none';
                    document.getElementById('pitchViewModal').style.display = 'flex';
                }
            } catch (error) {
                console.error('Error fetching campaign:', error);
            }
        }

        async function viewLeadDetails(leadId, event) {
            event.preventDefault();
            event.stopPropagation();
            const token = localStorage.getItem('token');

            try {
                const response = await fetch(`/api/leads/${leadId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const leadData = await response.json();
                    displayLeadDetail(leadData);
                    document.getElementById('activityModal').style.display = 'none';
                    document.getElementById('pitchViewModal').style.display = 'flex';
                }
            } catch (error) {
                console.error('Error fetching lead:', error);
            }
        }

        async function viewSocialFromHistory(postId, event) {
            event.preventDefault();
            event.stopPropagation();
            const token = localStorage.getItem('token');

            try {
                const response = await fetch(`/api/social-media/${postId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const postData = await response.json();
                    displaySocialDetail(postData);
                    document.getElementById('activityModal').style.display = 'none';
                    document.getElementById('pitchViewModal').style.display = 'flex';
                }
            } catch (error) {
                console.error('Error fetching social post:', error);
            }
        }

        function displayPitchModal(pitchData) {
            const modalTitle = `${pitchData.product} ‚Üí ${pitchData.persona}`;
            document.getElementById('modalPitchTitle').textContent = modalTitle;

            const pitch = pitchData.ai_output;
            const modalBody = `
                <div class="pitch-modal-content">
                    <div class="pitch-info">
                        <div class="info-row">
                            <strong>Industry:</strong> <span>${pitchData.industry}</span>
                        </div>
                        <div class="info-row">
                            <strong>Customer Type:</strong> <span>${pitchData.customer_type}</span>
                        </div>
                        <div class="info-row">
                            <strong>Budget Preference:</strong> <span>${pitchData.budget_preference}</span>
                        </div>
                        <div class="info-row">
                            <strong>Created:</strong> <span>${new Date(pitchData.created_at).toLocaleString()}</span>
                        </div>
                    </div>
                    
                    <hr class="section-divider">
                    
                    <div class="pitch-section">
                        <h4>Elevator Pitch</h4>
                        <p>${pitch.elevator_pitch}</p>
                    </div>
                    
                    <div class="pitch-section">
                        <h4>Value Proposition</h4>
                        <p>${pitch.value_proposition}</p>
                    </div>
                    
                    <div class="pitch-section">
                        <h4>Key Differentiators</h4>
                        <ul class="pitch-list">
                            ${pitch.key_differentiators.map(d => `<li>${d}</li>`).join('')}
                        </ul>
                    </div>
                    
                    <div class="pitch-section">
                        <h4>Call to Action</h4>
                        <p>${pitch.personalized_cta}</p>
                    </div>
                </div>
            `;

            document.getElementById('modalPitchBody').innerHTML = modalBody;
        }

        function displayCampaignDetail(campaignData) {
            const modalTitle = `${campaignData.product} - ${campaignData.platform}`;
            document.getElementById('modalPitchTitle').textContent = modalTitle;

            const campaign = campaignData.ai_output;
            const ideas = campaign.campaign_ideas || [];
            const ctas = campaign.cta_suggestions || [];
            const calendar = campaign.content_calendar || [];

            const modalBody = `
                <div class="pitch-modal-content">
                    <div class="pitch-info">
                        <div class="info-row">
                            <strong>Platform:</strong> <span>${campaignData.platform}</span>
                        </div>
                        <div class="info-row">
                            <strong>Industry:</strong> <span>${campaignData.industry}</span>
                        </div>
                        <div class="info-row">
                            <strong>Audience:</strong> <span>${campaignData.audience}</span>
                        </div>
                        <div class="info-row">
                            <strong>Created:</strong> <span>${new Date(campaignData.created_at).toLocaleString()}</span>
                        </div>
                    </div>
                    
                    <hr class="section-divider">
                    
                    <div class="pitch-section">
                        <h4>Campaign Ideas</h4>
                        ${ideas.length > 0 ? ideas.map(idea => `
                            <div style="margin-bottom: 1rem; padding: 0.75rem; background: var(--bg-tertiary); border-radius: 0.5rem;">
                                <strong>${idea.title}</strong>
                                <p style="margin: 0.5rem 0 0 0; color: #cbd5e1;">${idea.description}</p>
                            </div>
                        `).join('') : '<p>No campaign ideas</p>'}
                    </div>
                    
                    <hr class="section-divider">
                    
                    <div class="pitch-section">
                        <h4>Call to Actions</h4>
                        ${ctas.length > 0 ? ctas.map(cta => `
                            <div style="margin-bottom: 0.75rem; padding: 0.75rem; background: var(--bg-tertiary); border-radius: 0.5rem;">
                                <strong>${cta.cta_text}</strong>
                                <p style="margin: 0.25rem 0 0 0; font-size: 0.875rem; color: #cbd5e1;">${cta.description}</p>
                            </div>
                        `).join('') : '<p>No CTAs</p>'}
                    </div>
                    
                    <hr class="section-divider">
                    
                    <div class="pitch-section">
                        <h4>Content Calendar (7 Days)</h4>
                        ${calendar.length > 0 ? calendar.map(day => `
                            <div style="margin-bottom: 0.75rem; padding: 0.75rem; background: var(--bg-tertiary); border-radius: 0.5rem;">
                                <strong>Day ${day.day} - ${day.post_type}</strong>
                                <p style="margin: 0.25rem 0 0 0; font-size: 0.875rem; color: #cbd5e1;">${day.content_idea}</p>
                                <p style="margin: 0.25rem 0 0 0; font-size: 0.8rem; color: #64748b;">Best Time: ${day.best_time}</p>
                            </div>
                        `).join('') : '<p>No calendar data</p>'}
                    </div>
                </div>
            `;

            document.getElementById('modalPitchBody').innerHTML = modalBody;
        }

        function displayLeadDetail(leadData) {
            const modalTitle = `Lead - ${leadData.business_need}`;
            document.getElementById('modalPitchTitle').textContent = modalTitle;

            const leadAI = leadData.ai_output || {};

            const modalBody = `
                <div class="pitch-modal-content">
                    <div class="pitch-info">
                        <div class="info-row">
                            <strong>Business Need:</strong> <span>${leadData.business_need}</span>
                        </div>
                        <div class="info-row">
                            <strong>Budget:</strong> <span>${leadData.budget}</span>
                        </div>
                        <div class="info-row">
                            <strong>Industry:</strong> <span>${leadData.industry}</span>
                        </div>
                        <div class="info-row">
                            <strong>Urgency:</strong> <span>${leadData.urgency}</span>
                        </div>
                        <div class="info-row">
                            <strong>Authority:</strong> <span>${leadData.authority}</span>
                        </div>
                        <div class="info-row">
                            <strong>Created:</strong> <span>${new Date(leadData.created_at).toLocaleString()}</span>
                        </div>
                    </div>
                    
                    <hr class="section-divider">
                    
                    <div class="pitch-section">
                        <h4>Lead Quality Score</h4>
                        <div style="padding: 1.5rem; background: var(--bg-tertiary); border-radius: 0.5rem; text-align: center;">
                            <div style="font-size: 2.5rem; font-weight: bold; color: var(--primary); margin-bottom: 0.5rem;">
                                ${leadAI.lead_quality_score || 'N/A'}%
                            </div>
                            <p style="margin: 0; color: #cbd5e1;">${leadAI.overall_assessment || 'Assessment pending'}</p>
                        </div>
                    </div>
                    
                    <hr class="section-divider">
                    
                    <div class="pitch-section">
                        <h4>Reasoning</h4>
                        <p>${leadAI.reasoning || 'No reasoning provided'}</p>
                    </div>
                    
                    <div class="pitch-section">
                        <h4>Recommended Next Steps</h4>
                        <p>${leadAI.recommended_next_steps || 'No recommendations'}</p>
                    </div>
                </div>
            `;

            document.getElementById('modalPitchBody').innerHTML = modalBody;
        }

        function displaySocialDetail(postData) {
            const modalTitle = `Post - ${postData.product}`;
            document.getElementById('modalPitchTitle').textContent = modalTitle;

            const post = postData.ai_output;
            const platforms = ['LinkedIn', 'Instagram', 'Twitter'];
            const platformIcons = { 'LinkedIn': 'üíº', 'Instagram': 'üì∏', 'Twitter': 'üê¶' };

            const modalBody = `
                <div class="pitch-modal-content">
                    <div class="social-output-container">
                        <div class="poster-preview ${post.image_url ? 'ai-bg' : 'flyer-t' + postData.template_id}" style="${post.image_url ? 'background-image: url(' + post.image_url + ');' : ''}">
                            <div class="poster-overlay">
                                <div class="overlay-header">
                                    <h2 class="overlay-headline">${postData.product}</h2>
                                    <p class="overlay-subheadline">${postData.dept}</p>
                                </div>
                                <div class="overlay-tagline">${post.tagline || 'Excellence in every detail.'}</div>
                                <div class="overlay-footer">CONTACT: ${postData.contact}</div>
                            </div>
                        </div>

                        <div class="captions-grid">
                            ${platforms.map(p => post.captions && post.captions[p] ? `
                                <div class="caption-card">
                                    <h5>${platformIcons[p]} ${p} Caption</h5>
                                    <button class="copy-btn" onclick="copyCaptionText('${p}')">Copy</button>
                                    <pre id="caption-${p}">${post.captions[p]}</pre>
                                </div>
                            ` : '').join('')}
                        </div>
                        
                        <div style="margin-top: 1rem; width: 100%; display: flex; justify-content: center;">
                            <button class="btn btn-outline" onclick="downloadPosterPDF('${postData.product}')">
                                <span style="margin-right: 0.5rem;">üì•</span> Download PDF Poster
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('modalPitchBody').innerHTML = modalBody;
        }

        function copyCaptionText(platform) {
            const text = document.getElementById(`caption-${platform}`).textContent;
            navigator.clipboard.writeText(text).then(() => {
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = 'Copied!';
                btn.style.background = '#10b981';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '';
                }, 2000);
            });
        }

        async function downloadPosterPDF(productName) {
            const poster = document.querySelector('.poster-preview');
            const product = productName || 'poster';

            const btn = event.target.closest('.btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span>‚è≥</span> Exporting...';
            btn.disabled = true;

            try {
                const canvas = await html2canvas(poster, {
                    scale: 3,
                    useCORS: true,
                    backgroundColor: '#ffffff'
                });

                const imgData = canvas.toDataURL('image/png');
                const { jsPDF } = window.jspdf;

                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });

                const imgProps = pdf.getImageProperties(imgData);
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;

                pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                pdf.save(`${product.toLowerCase().replace(/\s+/g, '-')}-flyer.pdf`);

                btn.innerHTML = '<span>‚úÖ</span> Done!';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }, 2000);
            } catch (error) {
                console.error('PDF Export Error:', error);
                alert('Export failed. Please try again.');
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // Close modals when clicking outside of them
        window.addEventListener('click', (event) => {
            const pitchModal = document.getElementById('pitchViewModal');
            const activityModal = document.getElementById('activityModal');

            if (event.target === pitchModal) {
                pitchModal.style.display = 'none';
            }
            if (event.target === activityModal) {
                activityModal.style.display = 'none';
            }
        });
    </script>
</body>

</html>