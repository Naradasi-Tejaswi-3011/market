<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pitch Generator - MarketAI Suite</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='pitch_styles.css') }}">
</head>

<body>
    <nav class="navbar">
        <div class="nav-brand">
            <h1><span class="logo-icon"></span> MarketAI Suite</h1>
        </div>
        <div class="nav-menu">
            <a href="/" class="nav-link">Home</a>
            <a href="/campaign" class="nav-link">Campaigns</a>
            <a href="/pitch" class="nav-link active">Pitches</a>
            <a href="/lead" class="nav-link">Leads</a>
            <button id="logoutBtn" class="btn btn-logout">Logout</button>
        </div>
    </nav>

    <main class="container">
        <div class="page-header">
            <h2>ðŸŽ¯ Sales Pitch Generator</h2>
            <p>Personalized pitches with confidence scoring and explainability</p>
        </div>

        <div class="content-grid">
            <!-- Input Form -->
            <div class="form-section">
                <h3>Generate New Pitch</h3>
                <form id="pitchForm" class="form-group">
                    <div class="form-row">
                        <div class="form-col">
                            <label for="product">PRODUCT NAME *</label>
                            <input type="text" id="product" name="product" placeholder="Enter product name" required>
                        </div>

                        <div class="form-col">
                            <label for="industry">INDUSTRY *</label>
                            <input type="text" id="industry" name="industry" placeholder="e.g. Edtech, Healthcare"
                                required>
                        </div>
                    </div>

                    <div class="form-row full-width">
                        <label for="description">PRODUCT DESCRIPTION *</label>
                        <textarea id="description" name="description"
                            placeholder="Describe your product and its key features" rows="4" required></textarea>
                    </div>

                    <div class="form-row full-width">
                        <label for="persona">CUSTOMER PERSONA *</label>
                        <input type="text" id="persona" name="persona"
                            placeholder="e.g., CTO of mid-sized tech company, Marketing Director, Students" required>
                    </div>

                    <div class="form-row">
                        <div class="form-col">
                            <label for="customer_type">WHO ARE YOU SELLING TO? *</label>
                            <select id="customer_type" name="customer_type" required>
                                <option value="">Select customer type</option>
                                <option value="Individual Customer">Individual Customer</option>
                                <option value="Small Business / Coaching Institute">Small Business / Coaching Institute
                                </option>
                                <option value="Educational Institute / College">Educational Institute / College</option>
                                <option value="Medium Company">Medium Company</option>
                                <option value="Large Enterprise">Large Enterprise</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-col">
                            <label for="budget_preference">CUSTOMER BUDGET PREFERENCE *</label>
                            <select id="budget_preference" name="budget_preference" required>
                                <option value="">Select budget preference</option>
                                <option value="Budget Friendly">Budget Friendly (Below â‚¹30,000 per unit)</option>
                                <option value="Mid Range">Mid Range (â‚¹30,000 - â‚¹70,000)</option>
                                <option value="Premium">Premium (Above â‚¹70,000)</option>
                                <option value="Not Sure">Not Sure</option>
                            </select>
                        </div>

                        <div class="form-col">
                            <label for="language">PITCH LANGUAGE *</label>
                            <select id="language" name="language" required>
                                <option value="English">English</option>
                                <option value="Telugu">Telugu</option>
                                <option value="Hindi">Hindi</option>
                                <option value="Tamil">Tamil</option>
                                <option value="Malayalam">Malayalam</option>
                                <option value="Kannada">Kannada</option>
                            </select>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary btn-block" style="margin-top: 20px;">
                        Generate Pitch
                    </button>
                </form>

                <div id="formMessage" class="message"></div>
            </div>

            <!-- Output Results -->
            <div class="results-section">
                <div id="loadingSpinner" class="spinner" style="display: none;">
                    <div class="spinner-content">
                        <div class="spinner-circle"></div>
                        <p>Crafting personalized pitch...</p>
                    </div>
                </div>

                <div id="pitchOutput" style="display: none;" class="pitch-output-container">
                    <div class="pitch-header">
                        <h3 id="resultProductName">Product Name</h3>
                        <span id="resultDate" class="date-badge"></span>
                        <div class="tags">
                            <span id="resultIndustry" class="tag tag-blue">Industry</span>
                            <span id="resultCustomerType" class="tag tag-purple">Customer</span>
                        </div>
                    </div>

                    <div class="output-card-clean">
                        <div class="output-section">
                            <h4>Customer Persona: <span id="resultPersona" class="output-value"></span></h4>
                            <h4>Customer Type: <span id="resultCustomerTypeDisplay" class="output-value"></span></h4>
                            <h4>Budget Preference: <span id="resultBudget" class="output-value"></span></h4>
                        </div>

                        <hr class="divider">

                        <div class="output-section">
                            <h4>Elevator Pitch:</h4>
                            <p id="elevatorPitch" class="pitch-text"></p>
                        </div>

                        <hr class="divider">

                        <div class="output-section">
                            <h4>Value Proposition:</h4>
                            <p id="valueProposition"></p>
                        </div>

                        <hr class="divider">

                        <div class="output-section">
                            <h4>Key Differentiators:</h4>
                            <ul id="differentiators" class="diff-list"></ul>
                        </div>

                        <hr class="divider">

                        <div class="output-section">
                            <h4>Call to Action:</h4>
                            <p id="personalizedCTA"></p>
                        </div>
                    </div>

                    <button id="savePitchBtn" class="btn btn-success" style="margin-top: 20px; width: 100%;">
                        âœ“ Save Pitch
                    </button>
                </div>

                <div id="previousPitches" class="previous-outputs" style="margin-top: 40px;">
                    <h4>Pitch History</h4>
                    <div id="pitchList" class="output-list"></div>
                </div>
            </div>
        </div>
    </main>

    <footer class="footer">
        <p>&copy; 2026 MarketAI Suite - Explainable AI for Business Intelligence</p>
    </footer>

    <script src="{{ url_for('static', filename='app.js') }}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', checkAuth);
        document.getElementById('pitchForm').addEventListener('submit', generatePitch);
        document.getElementById('logoutBtn').addEventListener('click', logout);

        async function generatePitch(e) {
            e.preventDefault();

            const token = localStorage.getItem('token');
            const formData = {
                product: document.getElementById('product').value,
                description: document.getElementById('description').value,
                persona: document.getElementById('persona').value,
                industry: document.getElementById('industry').value,
                customer_type: document.getElementById('customer_type').value,
                budget_preference: document.getElementById('budget_preference').value,
                language: document.getElementById('language').value
            };

            document.getElementById('loadingSpinner').style.display = 'flex';
            document.getElementById('pitchOutput').style.display = 'none';
            const formMessage = document.getElementById('formMessage');
            formMessage.textContent = '';
            formMessage.classList.remove('error');
            formMessage.style.display = 'none';

            try {
                const response = await fetch('/api/pitches/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();
                document.getElementById('loadingSpinner').style.display = 'none';

                if (response.ok) {
                    displayPitchOutput(data.pitch, formData);
                    currentPitchId = data.pitch_id;
                    await loadPitches();
                } else {
                    document.getElementById('formMessage').textContent = data.error || 'Error generating pitch';
                    document.getElementById('formMessage').classList.add('error');
                }
            } catch (error) {
                document.getElementById('loadingSpinner').style.display = 'none';
                document.getElementById('formMessage').textContent = 'Network error. Please try again.';
                document.getElementById('formMessage').classList.add('error');
            }
        }

        function displayPitchOutput(pitch, formData) {
            // Header Info
            document.getElementById('resultProductName').textContent = formData.product;
            document.getElementById('resultDate').textContent = new Date().toLocaleDateString();
            document.getElementById('resultIndustry').textContent = formData.industry;
            document.getElementById('resultCustomerType').textContent = formData.customer_type;

            // Details
            document.getElementById('resultPersona').textContent = formData.persona;
            document.getElementById('resultCustomerTypeDisplay').textContent = formData.customer_type;
            document.getElementById('resultBudget').textContent = formData.budget_preference;

            // Content
            document.getElementById('elevatorPitch').textContent = pitch.elevator_pitch;
            document.getElementById('valueProposition').textContent = pitch.value_proposition;

            document.getElementById('differentiators').innerHTML = pitch.key_differentiators
                .map(d => `<li>${d}</li>`)
                .join('');

            document.getElementById('personalizedCTA').textContent = pitch.personalized_cta;

            document.getElementById('pitchOutput').style.display = 'block';
        }

        async function loadPitches() {
            const token = localStorage.getItem('token');

            try {
                const response = await fetch('/api/pitches', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    const html = data.pitches.length > 0
                        ? data.pitches.map((p, i) => `
                            <div class="pitch-item" onclick="viewPitch('${p._id}')" style="cursor: pointer;">
                                <h5>${p.product} â†’ ${p.persona}</h5>
                                <small>${new Date(p.created_at).toLocaleString()}</small>
                            </div>
                        `).join('')
                        : '<p>No pitches yet</p>';

                    document.getElementById('pitchList').innerHTML = html;
                }
            } catch (error) {
                console.error('Error loading pitches:', error);
            }
        }

        async function viewPitch(pitchId) {
            const token = localStorage.getItem('token');
            document.getElementById('loadingSpinner').style.display = 'flex';
            document.getElementById('pitchOutput').style.display = 'none';

            try {
                const response = await fetch(`/api/pitches/${pitchId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const pitchData = await response.json();

                    // Reconstruct formData from saved pitch data
                    const formData = {
                        product: pitchData.product,
                        industry: pitchData.industry,
                        persona: pitchData.persona,
                        customer_type: pitchData.customer_type,
                        budget_preference: pitchData.budget_preference
                    };

                    displayPitchOutput(pitchData.ai_output, formData);

                    // Update timestamp to show it's a history item
                    document.getElementById('resultDate').textContent = new Date(pitchData.created_at).toLocaleString();

                    document.getElementById('loadingSpinner').style.display = 'none';
                    document.getElementById('pitchOutput').style.display = 'block';

                    // Scroll to results
                    document.getElementById('pitchOutput').scrollIntoView({ behavior: 'smooth' });
                }
            } catch (error) {
                console.error('Error fetching pitch:', error);
                document.getElementById('loadingSpinner').style.display = 'none';
            }
        }

        let currentPitchId = null;

        document.addEventListener('DOMContentLoaded', () => {
            loadPitches();

            document.getElementById('savePitchBtn').addEventListener('click', () => {
                alert('Pitch saved successfully!');
            });
        });
    </script>
</body>

</html>