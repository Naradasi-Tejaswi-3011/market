<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pitch Generator - MarketAI Suite</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>
    <nav class="navbar">
        <div class="nav-brand">
            <h1><span class="logo-icon"></span> MarketAI Suite</h1>
        </div>
        <div class="nav-menu">
            <a href="/" class="nav-link">Home</a>
            <a href="/campaign" class="nav-link">Campaigns</a>
            <a href="/pitch" class="nav-link active">Pitches</a>
            <a href="/lead" class="nav-link">Leads</a>
            <button id="logoutBtn" class="btn btn-logout">Logout</button>
        </div>
    </nav>

    <main class="container">
        <div class="page-header">
            <h2>üéØ Sales Pitch Generator</h2>
            <p>Personalized pitches with confidence scoring and explainability</p>
        </div>

        <div class="content-grid">
            <!-- Input Form -->
            <div class="form-section">
                <h3>Generate New Pitch</h3>
                <form id="pitchForm" class="form-group">
                    <div>
                        <label for="product">Product Name *</label>
                        <input type="text" id="product" name="product" placeholder="Enter product name" required>
                    </div>

                    <div>
                        <label for="industry">Industry *</label>
                        <input type="text" id="industry" name="industry" placeholder="e.g., EdTech, Healthcare"
                            required>
                    </div>

                    <div>
                        <label for="description">Product Description *</label>
                        <textarea id="description" name="description"
                            placeholder="Describe your product and its key features" rows="4" required></textarea>
                    </div>

                    <div>
                        <label for="persona">Customer Persona *</label>
                        <input type="text" id="persona" name="persona" placeholder="e.g., CTO of mid-sized tech company"
                            required>
                    </div>

                    <div class="form-row">
                        <div class="form-col">
                            <label for="customer_type">WHO ARE YOU SELLING TO? *</label>
                            <select id="customer_type" name="customer_type" required>
                                <option value="">Select customer type</option>
                                <option value="Individual Customer">Individual Customer</option>
                                <option value="Small Business / Coaching Institute">Small Business / Coaching Institute
                                </option>
                                <option value="Educational Institute / College">Educational Institute / College</option>
                                <option value="Medium Company">Medium Company</option>
                                <option value="Large Enterprise">Large Enterprise</option>
                            </select>
                        </div>

                        <div class="form-col">
                            <label for="budget_preference">CUSTOMER BUDGET PREFERENCE *</label>
                            <select id="budget_preference" name="budget_preference" required>
                                <option value="">Select budget preference</option>
                                <option value="Budget Friendly">Budget Friendly (Below ‚Çπ30,000 per unit)</option>
                                <option value="Mid Range">Mid Range (‚Çπ30,000 - ‚Çπ70,000)</option>
                                <option value="Premium">Premium (Above ‚Çπ70,000)</option>
                                <option value="Not Sure">Not Sure</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label for="language">OUTPUT LANGUAGE *</label>
                        <select id="language" name="language" required>
                            <option value="English">English</option>
                            <option value="Hindi">Hindi</option>
                            <option value="Telugu">Telugu</option>
                        </select>
                    </div>

                    <button type="submit" class="btn btn-primary btn-block">
                        Generate Pitch
                    </button>
                </form>

                <div id="formMessage" class="message"></div>
            </div>

            <!-- Output Results -->
            <div class="results-section">
                <div id="toolDescription" class="tool-description">
                    <h3>AI Pitch Generator</h3>
                    <p>Generate personalized sales pitches powered by AI instantly.</p>

                    <div class="feature-list">
                        <div class="feature-item">
                            <span class="feature-icon">üí¨</span>
                            <div>
                                <strong>Personalized Pitches</strong>
                                <p>Tailored to your customer persona and needs</p>
                            </div>
                        </div>
                        <div class="feature-item">
                            <span class="feature-icon">üéØ</span>
                            <div>
                                <strong>Value Proposition</strong>
                                <p>Clearly articulated benefits and differentiators</p>
                            </div>
                        </div>
                        <div class="feature-item">
                            <span class="feature-icon">üìû</span>
                            <div>
                                <strong>Call to Action</strong>
                                <p>Optimized CTAs for conversion</p>
                            </div>
                        </div>
                        <div class="feature-item">
                            <span class="feature-icon">‚ö°</span>
                            <div>
                                <strong>Instant Generation</strong>
                                <p>Get results in seconds with AI</p>
                            </div>
                        </div>
                    </div>

                    <div class="how-it-works">
                        <h4>How It Works</h4>
                        <ol>
                            <li>Enter your product details</li>
                            <li>Describe your target customer</li>
                            <li>Select customer type and budget</li>
                            <li>Click Generate and get your personalized pitch</li>
                        </ol>
                    </div>
                </div>

                <div id="loadingSpinner" class="spinner" style="display: none;">
                    <div class="spinner-content">
                        <div class="spinner-circle"></div>
                        <p>Crafting personalized pitch...</p>
                    </div>
                </div>

                <div id="pitchOutput" style="display: none;">
                    <div class="output-card">
                        <div class="pitch-header">
                            <h3 id="resultProductName">Product Name</h3>
                            <span id="resultDate" class="date-badge"></span>
                            <div class="tags">
                                <span id="resultIndustry" class="tag tag-blue">Industry</span>
                                <span id="resultCustomerType" class="tag tag-purple">Customer</span>
                            </div>
                        </div>

                        <hr class="divider">

                        <div class="output-section">
                            <h4>Customer Persona: <span id="resultPersona" class="output-value"></span></h4>
                            <h4>Customer Type: <span id="resultCustomerTypeDisplay" class="output-value"></span></h4>
                            <h4>Budget Preference: <span id="resultBudget" class="output-value"></span></h4>
                        </div>

                        <hr class="divider">

                        <div class="output-section">
                            <h4>Elevator Pitch:</h4>
                            <p id="elevatorPitch" class="pitch-text"></p>
                        </div>

                        <hr class="divider">

                        <div class="output-section">
                            <h4>Value Proposition:</h4>
                            <p id="valueProposition"></p>
                        </div>

                        <hr class="divider">

                        <div class="output-section">
                            <h4>Key Differentiators:</h4>
                            <ul id="differentiators" class="diff-list"></ul>
                        </div>

                        <hr class="divider">

                        <div class="output-section">
                            <h4>Call to Action:</h4>
                            <p id="personalizedCTA"></p>
                        </div>
                    </div>

                    <!-- Feedback Section -->
                    <div id="feedbackSection" class="feedback-section" style="display: none;">
                        <h4>Was this sales pitch helpful?</h4>
                        <div class="feedback-buttons">
                            <button class="feedback-btn" id="feedbackUp" onclick="handleFeedback(true)">
                                üëç <span>Yes</span>
                            </button>
                            <button class="feedback-btn" id="feedbackDown" onclick="handleFeedback(false)">
                                üëé <span>No</span>
                            </button>
                        </div>
                        <div id="feedbackMsg" class="feedback-message">Thank you for your feedback!</div>
                    </div>

                </div>
            </div>
        </div>
    </main>

    <footer class="footer">
        <p>&copy; 2026 MarketAI Suite - Explainable AI for Business Intelligence</p>
    </footer>

    <!-- Feedback Modal -->
    <div id="feedbackModalOverlay" class="modal-overlay">
        <div class="feedback-modal">
            <div class="modal-header">
                <h3>Share feedback</h3>
                <button class="close-modal" onclick="closeFeedbackModal()">&times;</button>
            </div>
            <div class="reason-chips" id="reasonChips">
                <button class="reason-chip" onclick="toggleReason(this)">Incorrect or incomplete</button>
                <button class="reason-chip" onclick="toggleReason(this)">Not what I asked for</button>
                <button class="reason-chip" onclick="toggleReason(this)">Slow or buggy</button>
                <button class="reason-chip" onclick="toggleReason(this)">Style or tone</button>
                <button class="reason-chip" onclick="toggleReason(this)">Safety or legal concern</button>
                <button class="reason-chip" onclick="toggleReason(this)">Other</button>
            </div>
            <textarea id="feedbackDetails" class="feedback-details" placeholder="Share details (optional)"></textarea>
            <div class="modal-disclaimer">
                Your conversation will be included with your feedback to help improve MarketAI. <a href="#">Learn
                    more</a>
            </div>
            <div class="modal-footer">
                <button id="submitDetailedFeedback" class="btn-submit-feedback" onclick="submitDetailedFeedback()"
                    disabled>Submit</button>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='app.js') }}"></script>
    <script>
        let currentPitchId = null;
        document.addEventListener('DOMContentLoaded', checkAuth);
        document.getElementById('pitchForm').addEventListener('submit', generatePitch);
        document.getElementById('logoutBtn').addEventListener('click', logout);

        async function generatePitch(e) {
            e.preventDefault();

            const token = localStorage.getItem('token');
            const formData = {
                product: document.getElementById('product').value,
                description: document.getElementById('description').value,
                persona: document.getElementById('persona').value,
                industry: document.getElementById('industry').value,
                customer_type: document.getElementById('customer_type').value,
                budget_preference: document.getElementById('budget_preference').value,
                language: document.getElementById('language').value
            };

            document.getElementById('loadingSpinner').style.display = 'flex';
            document.getElementById('pitchOutput').style.display = 'none';
            document.getElementById('toolDescription').style.display = 'none';
            document.getElementById('formMessage').textContent = '';

            try {
                const response = await fetch('/api/pitches/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();
                document.getElementById('loadingSpinner').style.display = 'none';

                if (response.ok) {
                    displayPitchOutput(data.pitch, formData);
                    currentPitchId = data.pitch_id;
                } else {
                    document.getElementById('formMessage').textContent = data.error || 'Error generating pitch';
                    document.getElementById('formMessage').classList.add('error');
                }
            } catch (error) {
                document.getElementById('loadingSpinner').style.display = 'none';
                document.getElementById('formMessage').textContent = 'Network error. Please try again.';
                document.getElementById('formMessage').classList.add('error');
            }
        }

        function displayPitchOutput(pitch, formData) {
            // Header Info
            document.getElementById('resultProductName').textContent = formData.product;
            document.getElementById('resultDate').textContent = new Date().toLocaleDateString();
            document.getElementById('resultIndustry').textContent = formData.industry;
            document.getElementById('resultCustomerType').textContent = formData.customer_type;

            // Details
            document.getElementById('resultPersona').textContent = formData.persona;
            document.getElementById('resultCustomerTypeDisplay').textContent = formData.customer_type;
            document.getElementById('resultBudget').textContent = formData.budget_preference;

            // Content
            document.getElementById('elevatorPitch').textContent = pitch.elevator_pitch;
            document.getElementById('valueProposition').textContent = pitch.value_proposition;

            document.getElementById('differentiators').innerHTML = pitch.key_differentiators
                .map(d => `<li>${d}</li>`)
                .join('');

            document.getElementById('personalizedCTA').textContent = pitch.personalized_cta;

            document.getElementById('pitchOutput').style.display = 'block';

            // Show feedback section and reset buttons
            document.getElementById('feedbackSection').style.display = 'block';
            document.getElementById('feedbackMsg').style.display = 'none';
            document.getElementById('feedbackUp').classList.remove('active-up');
            document.getElementById('feedbackDown').classList.remove('active-down');
            document.getElementById('feedbackUp').disabled = false;
            document.getElementById('feedbackDown').disabled = false;
        }

        async function handleFeedback(isPositive) {
            if (!currentPitchId) return;

            if (isPositive) {
                await submitFeedback(true);
                document.getElementById('feedbackMsg').style.display = 'block';
                document.getElementById('feedbackUp').classList.add('active-up');
                document.getElementById('feedbackDown').classList.remove('active-down');
                document.getElementById('feedbackUp').disabled = true;
                document.getElementById('feedbackDown').disabled = true;
            } else {
                openFeedbackModal();
            }
        }

        function openFeedbackModal() {
            document.getElementById('feedbackModalOverlay').classList.add('active');
            const chips = document.querySelectorAll('.reason-chip');
            chips.forEach(c => c.classList.remove('selected'));
            document.getElementById('feedbackDetails').value = '';
            updateSubmitButtonState();
        }

        function closeFeedbackModal() {
            document.getElementById('feedbackModalOverlay').classList.remove('active');
        }

        function toggleReason(btn) {
            btn.classList.toggle('selected');
            updateSubmitButtonState();
        }

        function updateSubmitButtonState() {
            const selectedChips = document.querySelectorAll('.reason-chip.selected');
            const submitBtn = document.getElementById('submitDetailedFeedback');
            if (selectedChips.length > 0) {
                submitBtn.disabled = false;
                submitBtn.classList.add('ready');
            } else {
                submitBtn.disabled = true;
                submitBtn.classList.remove('ready');
            }
        }

        async function submitDetailedFeedback() {
            const selectedChips = document.querySelectorAll('.reason-chip.selected');
            const reasons = Array.from(selectedChips).map(c => c.textContent);
            const details = document.getElementById('feedbackDetails').value;

            await submitFeedback(false, reasons, details);

            closeFeedbackModal();
            document.getElementById('feedbackMsg').style.display = 'block';
            document.getElementById('feedbackMsg').textContent = 'Thank you for your detailed feedback!';
            document.getElementById('feedbackDown').classList.add('active-down');
            document.getElementById('feedbackUp').classList.remove('active-up');
            document.getElementById('feedbackUp').disabled = true;
            document.getElementById('feedbackDown').disabled = true;
        }

        async function submitFeedback(isPositive, reasons = [], details = '') {
            const token = localStorage.getItem('token');

            try {
                const response = await fetch('/api/feedback', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        content_id: currentPitchId,
                        content_type: 'pitch',
                        is_positive: isPositive,
                        reasons: reasons,
                        details: details
                    })
                });

                return response.ok;
            } catch (error) {
                console.error('Error submitting feedback:', error);
                return false;
            }
        }

        async function loadPitches() {
            const token = localStorage.getItem('token');

            try {
                const response = await fetch('/api/pitches', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    const html = data.pitches.length > 0
                        ? data.pitches.map((p, i) => `
                            <div class="pitch-item" onclick="viewPitch('${p._id}')" style="cursor: pointer;">
                                <h5>${p.product} ‚Üí ${p.persona}</h5>
                                <small>${new Date(p.created_at).toLocaleString()}</small>
                            </div>
                        `).join('')
                        : '<p>No pitches yet</p>';

                    document.getElementById('pitchList').innerHTML = html;
                }
            } catch (error) {
                console.error('Error loading pitches:', error);
            }
        }

        async function viewPitch(pitchId) {
            const token = localStorage.getItem('token');
            document.getElementById('loadingSpinner').style.display = 'flex';
            document.getElementById('pitchOutput').style.display = 'none';
            document.getElementById('toolDescription').style.display = 'none';

            try {
                const response = await fetch(`/api/pitches/${pitchId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const pitchData = await response.json();

                    // Reconstruct formData from saved pitch data
                    const formData = {
                        product: pitchData.product,
                        industry: pitchData.industry,
                        persona: pitchData.persona,
                        customer_type: pitchData.customer_type,
                        budget_preference: pitchData.budget_preference
                    };

                    displayPitchOutput(pitchData.ai_output, formData);

                    // Update timestamp to show it's a history item
                    document.getElementById('resultDate').textContent = new Date(pitchData.created_at).toLocaleString();

                    document.getElementById('loadingSpinner').style.display = 'none';
                    document.getElementById('pitchOutput').style.display = 'block';

                    // Scroll to results
                    document.getElementById('pitchOutput').scrollIntoView({ behavior: 'smooth' });
                }
            } catch (error) {
                console.error('Error fetching pitch:', error);
                document.getElementById('loadingSpinner').style.display = 'none';
            }
        }


        document.addEventListener('DOMContentLoaded', () => {
        });
    </script>
</body>

</html>